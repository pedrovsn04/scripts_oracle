17:08:00 PNXTL08.IT_PNET3>select dbms_metadata.get_ddl('PACKAGE','KBIX_JAVA_PPA','BIX') from dual;

DBMS_METADATA.GET_DDL('PACKAGE','KBIX_JAVA_PPA','BIX')
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

  CREATE OR REPLACE PACKAGE "BIX"."KBIX_JAVA_PPA" IS
   --
   -- MODIFICATION HISTORY
   -- Person             Date    Comments
   -- ---------------- -------- ------------------------------------------------------------------
   -- Fl¿o Alves     28.02.09 Migra¿ do BSCS 5.23 para BSCS iX
   -- Alexandre Borges 14.03.09 Migra¿ do BSCS 5.23 para BSCS iX (UCS-COM-OSS Interfaces_Prepago)
   -- Jadir Mendes     20.03.09 Migra¿ do BSCS 5.23 para BSCS iX (B18 e B19 PPA)
   -----------------------------------------------------------------------------------------------
   -- Rogério - 25/05/2012
   -- TS614 / D738 - PROCEDURE pbix_select_ppa_04
   -- Retorna a tecnologia
   ---------------------------------------------------------
   --   30/05/2012   <Cynthia Kiraly>   FS073.TS576.D751
   --   Function fbix_return_tmcode criada para
   --   atender a especificação TS576
   ---------------------------------------------------------

   TYPE type_cursor IS REF CURSOR;

   PROCEDURE pbix_get_all_simcards(p_cursor OUT type_cursor);

   PROCEDURE pbix_get_all_cdiactivesimcards(p_tmcode_list IN VARCHAR2,
                                            p_cursor      OUT type_cursor);

   PROCEDURE pbix_tmcode_des(p_dn_num IN directory_number.dn_num%TYPE,
                             p_cursor OUT type_cursor);

   /*   PROCEDURE pbix_upd_rtx_prepay_by_sncode(p_sncode_ppdis IN udr_lt.tariff_info_sncode%TYPE,
                                              p_sncode_ppsms IN udr_lt.tariff_info_sncode%TYPE);
   */
   PROCEDURE pbix_cons_valor_tarifado(p_sncode_ppdis          IN INTEGER,
                                      p_sncode_ppsms          IN INTEGER,
                                      p_cust_info_contract_id OUT INTEGER,
                                      p_tariff_info_sncode    OUT INTEGER,
                                      p_rated_flat_amount     OUT NUMBER);

   /*   PROCEDURE pbix_upd_rtx_prepay_contrato(p_cust_info_contract_id IN udr_lt.cust_info_contract_id%TYPE);*/

   PROCEDURE pbix_get_icms(p_dn_num    IN directory_number.dn_num%TYPE,
                           p_legalcode OUT tax_code_version.legalcode%TYPE);

   PROCEDURE pbix_has_cdi_oper_from_rtx(p_cust_info_contract_id IN INTEGER,
                                        p_cust_info_customer_id IN INTEGER,
                                        p_existe                OUT INTEGER);

   PROCEDURE pbix_get_default_rate(p_cursor OUT type_cursor);

   PROCEDURE pbix_get_sms_tariffs(p_cursor OUT type_cursor);

   PROCEDURE pbix_get_mms_tariffs(p_cursor OUT type_cursor);

   FUNCTION fbix_select_ppa_01(p_startdate IN DATE,
                               p_enddate   IN DATE) RETURN t_tab_rtx_prepay
      PIPELINED;

   FUNCTION fbix_select_ppa_02(p_dn_num IN directory_number.dn_num%TYPE) RETURN t_tab_sql_110_03
      PIPELINED;

   FUNCTION fbix_select_ppa_03(p_dn_num IN directory_number.dn_num%TYPE) RETURN t_tab_ppa_fselect03
      PIPELINED;

   PROCEDURE pbix_select_ppa_03(p_dn_num IN directory_number.dn_num%TYPE,
                                p_cursor OUT type_cursor);

   PROCEDURE pbix_customer_contract(p_telefone    IN VARCHAR2,
                                    p_co_id       OUT NUMBER,
                                    p_customer_id OUT NUMBER);

   PROCEDURE pbix_cursor_01(p_dn_num           IN VARCHAR2,
                            p_cut_off_date_ini IN DATE,
                            p_cut_off_date_fin IN DATE,
                            p_cursor           OUT type_cursor);
   PROCEDURE pbix_cursor_02(p_dn_num           IN VARCHAR2,
                            p_cut_off_date_ini IN DATE,
                            p_cut_off_date_fin IN DATE,
                            p_cursor           OUT type_cursor);
   -----------------------------------------
   -- Rogério - 25/05/2012
   -- TS614 / D738
   ------------------------------------------------------------------
   -- Cynthia Kiraly   31/05/2012   FS073.TS526.D760
   -- Inclusão do parâmetro de retorno Tipo de Conta (p_tp_conta)
   ------------------------------------------------------------------
   PROCEDURE pbix_select_ppa_04(p_dn_num     IN directory_number.dn_num%TYPE,
                                p_technology OUT bix.tbix_bscs_parameter_detail.cd_bscs_parameter%TYPE,
                                p_tp_conta   OUT VARCHAR2);

   PROCEDURE pbix_select_ppa_05(p_dn_num     IN directory_number.dn_num%TYPE,
                                p_cursor     OUT type_cursor);

   ---------------------------------------------------------
   --   30/05/2012   <Cynthia Kiraly>   FS073.TS576.D751
   --   Function fbix_return_tmcode criada para
   --   atender a especificação TS576
   ---------------------------------------------------------
   FUNCTION fbix_return_tmcode(p_dn_num IN VARCHAR2) RETURN NUMBER;

END;
CREATE OR REPLACE PACKAGE BODY "BIX"."KBIX_JAVA_PPA" IS

   PROCEDURE pbix_get_all_cdiactivesimcards(p_tmcode_list IN VARCHAR2,
                                            p_cursor      OUT type_cursor) IS
      /*************************************************************************************************
          20.03.2009  Jadir Mendes                      Migra¿ do BSCS 5.23 para BSCS iX
      **************************************************************************************************/
      v_qry VARCHAR2(32767);
   BEGIN

      -- PPA (B19) SIMCardDB_002_getAllCDIActiveSIMCards

      /*OPEN p_cursor FOR
      SELECT dnm.dn_num,
             cts.co_id,
             cta.customer_id,
             cta.tmcode
        FROM directory_number   dnm,
             contract_all       cta,
             contr_services_cap cts
       WHERE dnm.dn_id = cts.dn_id
         AND cta.co_id = cts.co_id
         AND cts.main_dirnum = 'X'
         AND cta.tmcode IN (1052, 1068)
         AND (cts.co_id, cts.seqno) IN
             (SELECT c.co_id,
                     c.seqno
                FROM (SELECT cts.co_id,
                             cts.seqno,
                             COUNT(*) AS qtd
                        FROM contr_services_cap  cts,
                             pr_serv_status_hist pssh,
                             contract_all        ca
                       WHERE pssh.profile_id = cts.profile_id
                         AND pssh.co_id = cts.co_id
                         AND pssh.sncode = cts.sncode
                         AND ca.co_id = pssh.co_id
                         AND cts.seqno = (SELECT MAX(c.seqno)
                                            FROM contr_services_cap c
                                           WHERE c.main_dirnum = 'X'
                                             AND c.co_id = cts.co_id)
                         AND pssh.status = 'D'
                         AND cts.sncode = 631 -- sncode = 632 - Servico Credito Disponivel
                      -- sncode = 631 - CDI Di¿o PP
                       GROUP BY cts.dn_id,
                                cts.co_id,
                                ca.tmcode,
                                cts.seqno
                      HAVING COUNT(*) >= 2) c); --Garante que tenha os dois servi¿ 632 e 631.*/

      /******* Ricardo F. de Araújo ******
        Alteração para trazer o sncode da tbix_bscs_parameter_detail
      */
      v_qry := 'SELECT dn.dn_num,' || chr(10) || '       co.co_id,' || chr(10) ||
               '       co.customer_id,' || chr(10) || '       co.tmcode' || chr(10) ||
               '  FROM contract_all       co,' || chr(10) || '       contr_services_cap csc,' ||
               chr(10) || '       directory_number   dn,' || chr(10) ||
               '       tbix_bscs_parameter_detail tp ' || chr(10) || ' WHERE co.tmcode IN (' ||
               p_tmcode_list || ')' || chr(10) || '   AND co.co_id = csc.co_id' || chr(10) ||
               '   AND csc.profile_id = 0' || chr(10) ||
               '   AND csc.sncode = tp.vl_bscs_parameter ' || chr(10) || -- 191' || chr(10) ||
               '   AND tp.cd_bscs_parameter = ''TEL_PRE'' ' || chr(10) ||
               '   AND csc.main_dirnum = ''X''' || chr(10) || '   AND csc.cs_deactiv_date is null' ||
               chr(10) || '   AND csc.dn_id = dn.dn_id' || chr(10) || '   AND dn.dirnum_npcode = 1' ||
               chr(10) || '   AND EXISTS (SELECT ''X''' || chr(10) ||
               '          FROM profile_service     ps,' || chr(10) ||
               '               pr_serv_status_hist psh,' || chr(10) ||
               '               tbix_bscs_parameter_detail tp ' || chr(10) ||
               '         WHERE ps.profile_id = csc.profile_id' || chr(10) ||
               '           AND ps.co_id = csc.co_id' || chr(10) ||
               '           AND ps.sncode = tp.vl_bscs_parameter' || chr(10) || --631' || chr(10) ||
               '           AND tp.cd_bscs_parameter = ''CDI_PRE'' ' || chr(10) ||
               '           AND ps.profile_id = psh.profile_id' || chr(10) ||
               '           AND ps.co_id = psh.co_id' || chr(10) ||
               '           AND ps.sncode = psh.sncode' || chr(10) ||
               '           AND ps.status_histno = psh.histno' || chr(10) ||
               '           AND psh.status <> ''D'')';

      OPEN p_cursor FOR v_qry;

   EXCEPTION
      WHEN OTHERS THEN
         RAISE;
   END pbix_get_all_cdiactivesimcards;

   PROCEDURE pbix_get_all_simcards(p_cursor OUT type_cursor) IS
      /*************************************************************************************************
          20.03.2009  Jadir Mendes                      Migra¿ do BSCS 5.23 para BSCS iX
      **************************************************************************************************/
   BEGIN

      -- PPA - (B18) SIMCardDB_001_getAllSIMCards
      /******* Ricardo F. de Araújo ******
        Alteração para trazer o sncode da tbix_bscs_parameter_detail
      */
      OPEN p_cursor FOR
         SELECT '55' || dnm.dn_num dn_num,
                cts.co_id,
                cta.customer_id,
                cta.tmcode
           FROM directory_number   dnm,
                contract_all       cta,
                contr_services_cap cts
          WHERE cts.co_id = cta.co_id
            AND cts.main_dirnum = 'X'
            AND cta.tmcode IN (1052, 1068)
            AND (cts.co_id, cts.seqno) IN
                (SELECT c.co_id,
                        c.seqno
                   FROM (SELECT cts.co_id,
                                cts.seqno,
                                COUNT(*) AS qtd
                           FROM contr_services_cap         cts,
                                pr_serv_status_hist        pssh,
                                contract_all               ca,
                                tbix_bscs_parameter_detail tp
                          WHERE pssh.profile_id = cts.profile_id
                            AND pssh.co_id = cts.co_id
                            AND pssh.sncode = cts.sncode
                            AND ca.co_id = pssh.co_id
                            AND cts.seqno = (SELECT MAX(c.seqno)
                                               FROM contr_services_cap c
                                              WHERE c.main_dirnum = 'X'
                                                AND c.co_id = cts.co_id)
                            AND pssh.status NOT IN ('D')
                            AND cts.sncode = tp.vl_bscs_parameter -- sncode = 632 - Servico Credito Disponivel
                            AND tp.cd_bscs_parameter = 'CRED_DISP'
                          GROUP BY cts.dn_id,
                                   cts.co_id,
                                   ca.tmcode,
                                   cts.seqno
                         HAVING COUNT(*) >= 1) c)
            AND dnm.dn_id = cts.dn_id;

   EXCEPTION
      WHEN OTHERS THEN
         NULL;
   END pbix_get_all_simcards;

   PROCEDURE pbix_tmcode_des(p_dn_num IN directory_number.dn_num%TYPE,
                             p_cursor OUT type_cursor) IS

      -- ---------------- -------- -------------------------------------------
      -- Fl¿o Alves     28.02.09
      -- ---------------- -------- -------------------------------------------

   BEGIN

      OPEN p_cursor FOR

         SELECT tm.tmcode,
                tm.des
           FROM directory_number    dn,
                contr_services_cap  cs,
                pr_serv_status_hist pssh,
                rateplan_hist       rh,
                mputmtab            tm
          WHERE dn.dn_id = cs.dn_id
            AND cs.co_id = pssh.co_id
            AND cs.sncode = pssh.sncode
            AND cs.profile_id = pssh.profile_id
            AND rh.co_id = cs.co_id
            AND cs.main_dirnum = 'X'
            AND cs.cs_deactiv_date IS NULL
            AND pssh.status != 'D'
            AND rh.tmcode = tm.tmcode
            AND tm.vscode = (SELECT MAX(tm2.vscode) FROM mputmtab tm2 WHERE tm2.tmcode = tm.tmcode)
            AND dn.dn_num = p_dn_num
            AND rownum = 1;

   EXCEPTION
      WHEN OTHERS THEN
         RAISE;

   END pbix_tmcode_des;

   /* -- n¿ser¿mais necess¿os devido ¿ria¿ da tabela tppa_udr_processed que ficar¿o PPA para controle das chamadas de r¿o que j¿oram processados pelo tarifador
      conf. UCS-COM-OSS Interfaces_PrepagoV3.doc (B1)
   PROCEDURE pbix_upd_rtx_prepay_by_sncode(p_sncode_ppdis IN udr_lt.tariff_info_sncode%TYPE,
                                           p_sncode_ppsms IN udr_lt.tariff_info_sncode%TYPE) IS
   BEGIN
      \* Alexandre Borges - 14.03.09 - Migra¿ BSCS iX
      - UCS-COM-OSS Interfaces_Prepago.doc - (B1) - Atualiza o flag de processado da rtx_prepay pelo c¿digo do servi¿*\
      NULL;
      \*      UPDATE udr_lt
               SET processed_ind = 'P'
             WHERE processed_ind = 'N'
               AND tariff_info_sncode IN (p_sncode_ppdis, p_sncode_ppsms);
      *\
   EXCEPTION
      WHEN OTHERS THEN
         ROLLBACK;
         RAISE;
   END pbix_upd_rtx_prepay_by_sncode;*/

   PROCEDURE pbix_cons_valor_tarifado(p_sncode_ppdis          IN INTEGER,
                                      p_sncode_ppsms          IN INTEGER,
                                      p_cust_info_contract_id OUT INTEGER,
                                      p_tariff_info_sncode    OUT INTEGER,
                                      p_rated_flat_amount     OUT NUMBER) IS
   BEGIN
      /* Alexandre Borges - 14.03.09 - Migra¿ BSCS iX
      - UCS-COM-OSS Interfaces_Prepago.doc - (B2) - Consulta valor a ser debitado do saldo do assintante pr¿ago */
      SELECT cust_info_contract_id r_p_contract_id,
             tariff_info_sncode sncode,
             round(SUM(rated_flat_amount), 2) AS suma
        INTO p_cust_info_contract_id,
             p_tariff_info_sncode,
             p_rated_flat_amount
        FROM udr_lt
       WHERE tariff_info_sncode IN (p_sncode_ppdis, p_sncode_ppsms)
       GROUP BY cust_info_contract_id,
                tariff_info_sncode;

   EXCEPTION
      WHEN OTHERS THEN
         RAISE;
   END pbix_cons_valor_tarifado;

   /*  -- n¿ser¿mais necess¿os devido ¿ria¿ da tabela tppa_udr_processed que ficar¿o PPA para controle das chamadas de r¿o que j¿oram processados pelo tarifador
         conf. UCS-COM-OSS Interfaces_PrepagoV3.doc (B6)
      PROCEDURE pbix_upd_rtx_prepay_contrato(p_cust_info_contract_id IN udr_lt.cust_info_contract_id%TYPE) IS
      BEGIN
         \* Alexandre Borges - 14.03.09 - Migra¿ BSCS iX
         - UCS-COM-OSS Interfaces_Prepago.doc - (B6) - Atualiza o flag de processado da rtx_prepay pelo contrato *\
         NULL;
         \*      UPDATE udr_lt
           SET processed_ind = 'Y'
         WHERE processed_ind = 'P'
           AND cust_info_contract_id = p_cust_info_contract_id;*\

      EXCEPTION
         WHEN OTHERS THEN
            ROLLBACK;
            RAISE;
      END pbix_upd_rtx_prepay_contrato;
   */

   PROCEDURE pbix_get_icms(p_dn_num    IN directory_number.dn_num%TYPE,
                           p_legalcode OUT tax_code_version.legalcode%TYPE) IS
   BEGIN
      /* Alexandre Borges - 14.03.09 - Migra¿ BSCS iX
      - UCS-COM-OSS Interfaces_Prepago.doc - (B9) - Consulta al¿otas de ICMS pelo n¿mero de telefone
         Robertson Barqueiro - Adicionada a condição para trazer apenas a alíquota atual do estado.
         Ex: Paraná: até 2009 tinha alíquota de 27% e agora tem de 29%.
      */
      /******* Ricardo F. de Araújo ******
        Alteração para trazer o sncode da tbix_bscs_parameter_detail
      */
      SELECT DISTINCT tcv.legalcode
        INTO p_legalcode
        FROM directory_number           dn,
             contr_services_cap         csc,
             contract_all               co,
             customer_all               cu,
             customer_all               pay,
             individual_taxation        itx,
             customercatcode            ccc,
             service_taxation           st,
             servicecatcode             scc,
             tax_code                   tax,
             tax_code_version           tcv,
             tbix_bscs_parameter_detail tp
       WHERE dn.dn_num = p_dn_num
         AND dn.dn_id = csc.dn_id
         AND csc.main_dirnum = 'X'
         AND csc.sncode = tp.vl_bscs_parameter --IN (1, 191)
         AND tp.cd_bscs_parameter = 'TELEFONIA'
         AND csc.cs_deactiv_date IS NULL
         AND csc.cs_activ_date = (SELECT MAX(cs_activ_date)
                                    FROM contr_services_cap         cs,
                                         tbix_bscs_parameter_detail tp
                                   WHERE cs.profile_id = csc.profile_id
                                     AND cs.main_dirnum = 'X'
                                     AND cs.sncode = tp.vl_bscs_parameter -- IN (1, 191)
                                     AND tp.cd_bscs_parameter = 'TELEFONIA'
                                     AND cs.dn_id = csc.dn_id
                                     AND cs.cs_deactiv_date IS NULL)
         AND csc.co_id = co.co_id
         AND co.customer_id = cu.customer_id
         AND pay.customer_id = fbsc_paymntresp(cu.customer_id)
         AND pay.customer_id = itx.customer_id
         AND itx.valid_from =
             (SELECT MAX(valid_from) FROM individual_taxation WHERE customer_id = itx.customer_id)
         AND itx.customercat_code = ccc.customercat_code
         AND ccc.customercat_code = st.customercat_code
         AND st.servcat_id = scc.servcat_id
         AND scc.serv_code = 'ESTADUAL'
         AND tax.taxcode_name LIKE 'ICMS_' || ccc.shdes
         AND tax.taxcode = tcv.taxcode
         AND tcv.tax_seqno =
             (SELECT MAX(tax_seqno) FROM tax_code_version WHERE taxcode = tcv.taxcode);

   EXCEPTION
      WHEN OTHERS THEN
         RAISE;
   END pbix_get_icms;

   PROCEDURE pbix_has_cdi_oper_from_rtx(p_cust_info_contract_id IN INTEGER,
                                        p_cust_info_customer_id IN INTEGER,
                                        p_existe                OUT INTEGER) IS
      v_existe         VARCHAR2(10);
      v_qry            VARCHAR2(32767);
      v_partition_name VARCHAR2(4000);
   BEGIN
      /* Alexandre Borges - 14.03.09 - Migra¿ BSCS iX
      - UCS-COM-OSS Interfaces_Prepago.doc - (B11) - Verifica se houve uso do servi¿CDI di¿o para o contrato */

      /*SELECT COUNT(1)
       INTO p_existe
       FROM udr_lt rtx
      WHERE rtx.tariff_info_sncode = 553
        AND trunc(rtx.entry_date_timestamp) = trunc(SYSDATE - 1)
        AND rtx.cust_info_contract_id = p_cust_info_contract_id
        AND rtx.cust_info_customer_id = p_cust_info_customer_id
        AND rtx.rounded_volume > 0;*/

      v_existe := NULL;
      FOR c_cur IN (SELECT ini.partition_name     AS partition_ini,
                           ini.partition_position AS position_ini,
                           ini.high_value         AS high_value_ini,
                           fin.partition_name     AS partition_fin,
                           fin.partition_position AS positiion_fin,
                           fin.high_value         AS high_value_fin
                      FROM all_tab_partitions@bscs_to_rtx_link.world ini,
                           all_tab_partitions@bscs_to_rtx_link.world fin
                     WHERE ini.table_name = 'UDR_LT'
                       AND ini.table_name = fin.table_name(+)
                       AND ini.partition_position = fin.partition_position(+) - 1
                     ORDER BY ini.partition_position)
      LOOP
         v_qry := 'SELECT CASE WHEN trunc(SYSDATE - 1) BETWEEN ' || c_cur.high_value_ini || ' AND ' ||
                  nvl(c_cur.high_value_fin,
                      'TO_DATE('' 2048-12-31 00:00:00'', ''SYYYY-MM-DD HH24:MI:SS'', ''NLS_CALENDAR=GREGORIAN'')') ||
                  '   THEN ''X'' ELSE NULL END FROM dual';

         EXECUTE IMMEDIATE v_qry
            INTO v_existe;

         IF (v_existe = 'X') THEN
            v_partition_name := c_cur.partition_fin;
         END IF;

         EXIT WHEN v_existe = 'X';
      END LOOP;

      v_qry := 'SELECT COUNT(1)
                  FROM udr_lt PARTITION(' || v_partition_name || ')
                       ,tbix_bscs_parameter_detail tp
                 WHERE tariff_info_sncode = tp.vl_bscs_parameter
                   AND tp.vl_bscs_parameter = 553
                   AND trunc(entry_date_timestamp) = trunc(SYSDATE - 1)
                   AND cust_info_contract_id = :p_cust_info_contract_id
                   AND cust_info_customer_id = :p_cust_info_customer_id
                   AND rounded_volume > 0';
      EXECUTE IMMEDIATE v_qry
         INTO p_existe
         USING p_cust_info_contract_id, p_cust_info_customer_id;

   EXCEPTION
      WHEN OTHERS THEN
         RAISE;
   END pbix_has_cdi_oper_from_rtx;

   PROCEDURE pbix_get_default_rate(p_cursor OUT type_cursor) IS
   BEGIN
      /* Alexandre Borges - 14.03.09 - Migra¿ BSCS iX
      - UCS-COM-OSS Interfaces_Prepago.doc - (B15) - Consulta tarifa default de sms */

      OPEN p_cursor FOR
         SELECT servico,
                ricode,
                gvcode,
                vscode,
                zncode,
                zpdes,
                digits,
                other_zp_info,
                valor,
                icms
           FROM vbsc_tariff_prepaid
          WHERE other_zp_info = 'GENERAL';

   EXCEPTION
      WHEN OTHERS THEN
         RAISE;
   END pbix_get_default_rate;

   PROCEDURE pbix_get_sms_tariffs(p_cursor OUT type_cursor) IS
   BEGIN
      /* Alexandre Borges - 14.03.09 - Migra¿ BSCS iX
      - UCS-COM-OSS Interfaces_Prepago.doc - (B16) - consulta tarifas de sms */

      OPEN p_cursor FOR
         SELECT servico,
                ricode,
                gvcode,
                vscode,
                zncode,
                zpdes,
                digits,
                other_zp_info,
                valor,
                icms
           FROM vbsc_tariff_prepaid
          WHERE ricode = 297
            AND other_zp_info <> 'GENERAL'
            AND servico = 'SMS';

   EXCEPTION
      WHEN OTHERS THEN
         RAISE;
   END pbix_get_sms_tariffs;

   PROCEDURE pbix_get_mms_tariffs(p_cursor OUT type_cursor) IS
   BEGIN
      /* Alexandre Borges - 14.03.09 - Migra¿ BSCS iX
      - UCS-COM-OSS Interfaces_Prepago.doc - (B17) - consuta tarifas de mms */

      OPEN p_cursor FOR
         SELECT servico,
                ricode,
                gvcode,
                vscode,
                zncode,
                zpdes,
                digits,
                other_zp_info,
                valor,
                icms
           FROM vbsc_tariff_prepaid
          WHERE servico = 'MMS';

   EXCEPTION
      WHEN OTHERS THEN
         RAISE;
   END pbix_get_mms_tariffs;

   FUNCTION fbix_select_ppa_01(p_startdate IN DATE,
                               p_enddate   IN DATE) RETURN t_tab_rtx_prepay
      PIPELINED IS
      v_row_rtx_prepay t_row_rtx_prepay := t_row_rtx_prepay.constructor();

   BEGIN
      /*************************************************************************************************
       Migra¿ para BSCS iX - Query antiga da vers¿BSCS 5.23
       Fl¿o Alves   28/02/2009
      *************************************************************************************************

         SELECT c.START_D_T,
                c.RATED_FLAT_AMOUNT,
                c.PROCESSED_IND,
                c.ACTUAL_VOLUME
         FROM   rtx_prepay c,
                ppa.prep_telefonos n
         WHERE  c.R_P_CONTRACT_ID = n.CONTRATO
           and n.PHNUMBER = : dnnumber
           AND c.SNCODE = 30
           AND c.START_D_T >= TO_DATE(:startdate,'DD/MM/YYYY HH24:MI:SS')
           AND c.START_D_T < TO_DATE(:enddate,'DD/MM/YYYY HH24:MI:SS') + 1
           AND c.RTX_ENT_DATE  >= TO_DATE(:startdate,'DD/MM/YYYY HH24:MI:SS') - 3
           AND c.RTX_ENT_DATE < TO_DATE(:enddate,'DD/MM/YYYY HH24:MI:SS') + 4
           AND c.RTX_TYPE  = 'A'
         ORDER BY c.PROCESSED_IND, c.START_D_T DESC

      *************************************************************************************************/
      /******* Ricardo F. de Araújo ******
        Alteração para trazer o sncode da tbix_bscs_parameter_detail
      */
      FOR r1 IN (SELECT a.cust_info_customer_id,
                        a.cust_info_contract_id,
                        a.cust_info_bill_cycle,
                        a.uds_stream_id,
                        a.uds_record_id,
                        a.uds_base_part_id,
                        a.uds_charge_part_id,
                        a.uds_free_unit_part_id,
                        a.entry_date_timestamp,
                        start_time_timestamp    AS start_d_t,
                        rated_flat_amount       AS rated_flat_amount,
                        --                        processed_ind AS processed_ind,
                        CASE
                           WHEN duration_umcode IN (1, 8, 9) --1-Seconds, 8-Minutes, 9-Hours
                            THEN
                            duration_volume
                           WHEN data_volume_umcode IN (2, 10, 11, 12) --2-Bytes, 10-Kilo Bytes, 11-Mega Bytes, 12-Giga Bytes
                            THEN
                            data_volume
                           WHEN event_umcode IN (3, 4) --3-Message, 4-Events
                            THEN
                            event_volume
                           WHEN rated_clicks_umcode IN (7) --7-Rated Clicks
                            THEN
                            rated_clicks_volume
                           ELSE
                            0
                        END AS actual_volume,
                        cust_info_contract_id AS r_p_contract_id
                   FROM udr_lt                     a,
                        udc_rate_type_table        b,
                        tbix_bscs_parameter_detail tp
                  WHERE a.tariff_detail_rate_type_id = b.rate_type_id
                    AND tariff_info_sncode = tp.vl_bscs_parameter --30
                    AND tp.cd_bscs_parameter = 'RADIO_POS'
                    AND start_time_timestamp >= to_date(p_startdate, 'DD/MM/YYYY HH24:MI:SS')
                    AND start_time_timestamp < to_date(p_enddate, 'DD/MM/YYYY HH24:MI:SS') + 1
                    AND entry_date_timestamp >= to_date(p_startdate, 'DD/MM/YYYY HH24:MI:SS') - 3
                    AND entry_date_timestamp < to_date(p_enddate, 'DD/MM/YYYY HH24:MI:SS') + 4
                    AND rate_type_des = 'A'
                  ORDER BY start_time_timestamp DESC)
      LOOP
         v_row_rtx_prepay.cust_info_customer_id := r1.cust_info_customer_id;
         v_row_rtx_prepay.cust_info_contract_id := r1.cust_info_contract_id;
         v_row_rtx_prepay.cust_info_bill_cycle  := r1.cust_info_bill_cycle;
         v_row_rtx_prepay.uds_stream_id         := r1.uds_stream_id;
         v_row_rtx_prepay.uds_record_id         := r1.uds_record_id;
         v_row_rtx_prepay.uds_base_part_id      := r1.uds_base_part_id;
         v_row_rtx_prepay.uds_charge_part_id    := r1.uds_charge_part_id;
         v_row_rtx_prepay.uds_free_unit_part_id := r1.uds_free_unit_part_id;
         v_row_rtx_prepay.entry_date_timestamp  := r1.entry_date_timestamp;
         v_row_rtx_prepay.start_d_t             := r1.start_d_t;
         v_row_rtx_prepay.rated_flat_amount     := r1.rated_flat_amount;
         v_row_rtx_prepay.actual_volume         := r1.actual_volume;
         v_row_rtx_prepay.r_p_contract_id       := r1.r_p_contract_id;

         PIPE ROW(v_row_rtx_prepay);
      END LOOP;

      RETURN;

   END fbix_select_ppa_01;

   FUNCTION fbix_select_ppa_02(p_dn_num IN directory_number.dn_num%TYPE) RETURN t_tab_sql_110_03
      PIPELINED IS
      v_row t_row_sql_110_03 := t_row_sql_110_03.constructor();

   BEGIN

      FOR r1 IN (SELECT dn.dn_num,
                        cs.co_id
                   FROM contr_services_cap cs,
                        directory_number   dn,
                        contract_all       ca
                  WHERE cs.seqno = (SELECT MAX(c.seqno)
                                      FROM contr_services_cap c
                                     WHERE c.main_dirnum = 'X'
                                       AND c.co_id = cs.co_id)
                    AND cs.main_dirnum = 'X'
                    AND dn.dn_num = p_dn_num
                    AND cs.dn_id = dn.dn_id
                    AND cs.co_id = ca.co_id
                  ORDER BY 1,
                           2)
      LOOP

         v_row.dn_num := r1.dn_num;
         v_row.co_id  := r1.co_id;

         PIPE ROW(v_row);
      END LOOP;

      RETURN;

   END fbix_select_ppa_02;

   FUNCTION fbix_select_ppa_03(p_dn_num IN directory_number.dn_num%TYPE) RETURN t_tab_ppa_fselect03
      PIPELINED IS
      v_row t_row_ppa_fselect03 := t_row_ppa_fselect03.constructor();

   BEGIN
      /******* Ricardo F. de Araújo ******
        Alteração para trazer o sncode da tbix_bscs_parameter_detail
      */
      FOR r1 IN (SELECT csc.co_id,
                        decode((SELECT COUNT(1)
                                 FROM profile_service            ps,
                                      pr_serv_status_hist        psh,
                                      tbix_bscs_parameter_detail tp
                                WHERE ps.profile_id = csc.profile_id
                                  AND ps.co_id = csc.co_id
                                  AND ps.sncode = tp.vl_bscs_parameter --563
                                  AND tp.cd_bscs_parameter = 'TORPEDO'
                                  AND ps.profile_id = psh.profile_id
                                  AND ps.co_id = psh.co_id
                                  AND ps.sncode = psh.sncode
                                  AND ps.status_histno = psh.histno
                                  AND psh.status <> 'D'),
                               0,
                               'N',
                               'Y') AS nextel_ativo,
                        decode((SELECT COUNT(1)
                                 FROM profile_service            ps,
                                      pr_serv_status_hist        psh,
                                      tbix_bscs_parameter_detail tp
                                WHERE ps.profile_id = csc.profile_id
                                  AND ps.co_id = csc.co_id
                                  AND ps.sncode = tp.vl_bscs_parameter --585
                                  AND tp.cd_bscs_parameter = 'TORPEDO'
                                  AND ps.profile_id = psh.profile_id
                                  AND ps.co_id = psh.co_id
                                  AND ps.sncode = psh.sncode
                                  AND ps.status_histno = psh.histno
                                  AND psh.status <> 'D'),
                               0,
                               'N',
                               'Y') AS mms_ativo
                   FROM directory_number           dn,
                        contr_services_cap         csc,
                        profile_service            ps,
                        pr_serv_status_hist        psh,
                        tbix_bscs_parameter_detail tp
                  WHERE dn.dn_num = p_dn_num
                    AND dn.dn_id = csc.dn_id
                    AND csc.sncode = tp.vl_bscs_parameter -- IN (1, 191)
                    AND tp.cd_bscs_parameter = 'TELEFONIA'
                    AND csc.main_dirnum = 'X'
                    AND csc.cs_activ_date = (SELECT MAX(cs_activ_date)
                                               FROM contr_services_cap         cs,
                                                    tbix_bscs_parameter_detail tp
                                              WHERE cs.co_id = csc.co_id
                                                AND cs.sncode = tp.vl_bscs_parameter --IN (1, 191)
                                                AND tp.cd_bscs_parameter = 'TELEFONIA'
                                                AND cs.main_dirnum = 'X')
                    AND csc.profile_id = ps.profile_id
                    AND csc.co_id = ps.co_id
                    AND csc.sncode = ps.sncode
                    AND ps.profile_id = psh.profile_id
                    AND ps.co_id = psh.co_id
                    AND ps.sncode = psh.sncode
                    AND ps.status_histno = psh.histno
                    AND psh.status <> 'D')
      LOOP

         v_row.co_id            := r1.co_id;
         v_row.flg_nextel_ativo := r1.nextel_ativo;
         v_row.flg_mms_ativo    := r1.mms_ativo;

         PIPE ROW(v_row);
      END LOOP;

      RETURN;

   END fbix_select_ppa_03;

   PROCEDURE pbix_select_ppa_03(p_dn_num IN directory_number.dn_num%TYPE,
                                p_cursor OUT type_cursor) IS
   BEGIN
      /* Alexandre Borges - 01.05.09 - Migra¿ BSCS iX
      - UCS-COM-OSS Interfaces_PrepagoV3.doc - (B23) - Consulta informa¿s do telefone */
      OPEN p_cursor FOR
         SELECT tm.tmcode,
                tm.des
           FROM directory_number   a,
                contr_services_cap b,
                contract_all       c,
                mputmtab           tm
          WHERE a.dn_id = b.dn_id
            AND a.dn_num = p_dn_num
            AND a.dirnum_npcode = 1
            AND b.main_dirnum = 'X'
            AND c.co_id = b.co_id
            AND b.cs_deactiv_date IS NULL
            AND tm.tmcode = c.tmcode
            AND tm.vscode = (SELECT MAX(vscode) FROM mputmtab WHERE tmcode = tm.tmcode)
            AND b.seqno = (SELECT MAX(seqno)
                             FROM contr_services_cap
                            WHERE co_id = b.co_id
                              AND sncode = b.sncode
                              AND profile_id = b.profile_id);

   EXCEPTION
      WHEN OTHERS THEN
         RAISE;
   END pbix_select_ppa_03;

   PROCEDURE pbix_customer_contract(p_telefone    IN VARCHAR2,
                                    p_co_id       OUT NUMBER,
                                    p_customer_id OUT NUMBER) IS
   BEGIN

      SELECT co.co_id,
             co.customer_id
        INTO p_co_id,
             p_customer_id
        FROM directory_number   dn,
             contr_services_cap csc,
             contract_all       co
       WHERE dn.dirnum_npcode IN (1, 89)
         AND dn.dn_num = p_telefone -- (telefone ou radio)
         AND csc.dn_id = dn.dn_id
         AND csc.cs_activ_date IS NOT NULL
         AND csc.cs_deactiv_date IS NULL
         AND csc.co_id = co.co_id;

   EXCEPTION
      WHEN no_data_found THEN
         p_co_id       := NULL;
         p_customer_id := NULL;
      WHEN OTHERS THEN
         RAISE;
   END;

   /******* Ricardo F. de Araújo ******
     Alteração para trazer o sncode da tbix_bscs_parameter_detail
   */
   PROCEDURE pbix_cursor_01(p_dn_num           IN VARCHAR2,
                            p_cut_off_date_ini IN DATE,
                            p_cut_off_date_fin IN DATE,
                            p_cursor           OUT type_cursor) IS
      v_co_id       NUMBER;
      v_customer_id NUMBER;
   BEGIN

      kbix_java_ppa.pbix_customer_contract(p_dn_num, v_co_id, v_customer_id);

      OPEN p_cursor FOR
         SELECT to_char(start_time_timestamp, 'DD/MM/RRRR HH24:MI:SS') start_date,
                o_p_number_address number_destination,
                lpad(trunc(to_number(CASE
                                        WHEN duration_umcode IN (1, 8, 9) --1-seconds, 8-minutes, 9-hours
                                         THEN
                                         duration_volume
                                        ELSE
                                         CASE
                                            WHEN data_volume_umcode IN (2, 10, 11, 12) --2-bytes, 10-kilo bytes, 11-mega bytes, 12-giga bytes
                                             THEN
                                             data_volume
                                            ELSE
                                             CASE
                                                WHEN event_umcode IN (3, 4) --3-message, 4-events
                                                 THEN
                                                 event_volume
                                                ELSE
                                                 CASE
                                                    WHEN rated_clicks_umcode IN (7) --7-rated clicks
                                                     THEN
                                                     rated_clicks_volume
                                                    ELSE
                                                     0
                                                 END
                                             END
                                         END
                                     END) / 60),
                     2,
                     '0') || ':' || lpad(trunc(MOD(to_number(CASE
                                                                WHEN duration_umcode IN (1, 8, 9) --1-seconds, 8-minutes, 9-hours
                                                                 THEN
                                                                 duration_volume
                                                                ELSE
                                                                 CASE
                                                                    WHEN data_volume_umcode IN (2, 10, 11, 12) --2-bytes, 10-kilo bytes, 11-mega bytes, 12-giga bytes
                                                                     THEN
                                                                     data_volume
                                                                    ELSE
                                                                     CASE
                                                                        WHEN event_umcode IN (3, 4) --3-message, 4-events
                                                                         THEN
                                                                         event_volume
                                                                        ELSE
                                                                         CASE
                                                                            WHEN rated_clicks_umcode IN (7) --7-rated clicks
                                                                             THEN
                                                                             rated_clicks_volume
                                                                            ELSE
                                                                             0
                                                                         END
                                                                     END
                                                                 END
                                                             END),
                                                   60)),
                                         2,
                                         '0') call_duration,
                to_char(rated_flat_amount) current_balance
           FROM udr_lt                     r,
                tbix_bscs_parameter_detail tp
          WHERE to_char(r.tariff_info_sncode) = tp.vl_bscs_parameter -- IN (29, 30)
            AND tp.cd_bscs_parameter = 'RADIO_CDR'
            AND trunc(start_time_timestamp) >= trunc(p_cut_off_date_ini)
            AND trunc(start_time_timestamp) <= trunc(p_cut_off_date_fin)
            AND r.cust_info_contract_id = v_co_id
            AND r.cust_info_customer_id = v_customer_id
            AND r.call_type = 1
          ORDER BY start_time_timestamp;

   EXCEPTION
      WHEN no_data_found THEN
         NULL;
      WHEN OTHERS THEN
         RAISE;

   END pbix_cursor_01;

   PROCEDURE pbix_cursor_02(p_dn_num           IN VARCHAR2,
                            p_cut_off_date_ini IN DATE,
                            p_cut_off_date_fin IN DATE,
                            p_cursor           OUT type_cursor) IS
      v_co_id       NUMBER;
      v_customer_id NUMBER;
   BEGIN

      kbix_java_ppa.pbix_customer_contract(p_dn_num, v_co_id, v_customer_id);

      OPEN p_cursor FOR
         SELECT o_p_number_address,
                to_char(start_time_timestamp, 'dd/mm/rrrr hh24:mi:ss') start_time_timestamp,
                lpad(trunc(to_number(CASE
                                        WHEN duration_umcode IN (1, 8, 9) --1-seconds, 8-minutes, 9-hours
                                         THEN
                                         duration_volume
                                        ELSE
                                         CASE
                                            WHEN data_volume_umcode IN (2, 10, 11, 12) --2-bytes, 10-kilo bytes, 11-mega bytes, 12-giga bytes
                                             THEN
                                             data_volume
                                            ELSE
                                             CASE
                                                WHEN event_umcode IN (3, 4) --3-message, 4-events
                                                 THEN
                                                 event_volume
                                                ELSE
                                                 CASE
                                                    WHEN rated_clicks_umcode IN (7) --7-rated clicks
                                                     THEN
                                                     rated_clicks_volume
                                                    ELSE
                                                     0
                                                 END
                                             END
                                         END
                                     END) / 60),
                     2,
                     '0') || ':' || lpad(trunc(MOD(to_number(CASE
                                                                WHEN duration_umcode IN (1, 8, 9) --1-seconds, 8-minutes, 9-hours
                                                                 THEN
                                                                 duration_volume
                                                                ELSE
                                                                 CASE
                                                                    WHEN data_volume_umcode IN (2, 10, 11, 12) --2-bytes, 10-kilo bytes, 11-mega bytes, 12-giga bytes
                                                                     THEN
                                                                     data_volume
                                                                    ELSE
                                                                     CASE
                                                                        WHEN event_umcode IN (3, 4) --3-message, 4-events
                                                                         THEN
                                                                         event_volume
                                                                        ELSE
                                                                         CASE
                                                                            WHEN rated_clicks_umcode IN (7) --7-rated clicks
                                                                             THEN
                                                                             rated_clicks_volume
                                                                            ELSE
                                                                             0
                                                                         END
                                                                     END
                                                                 END
                                                             END),
                                                   60)),
                                         2,
                                         '0') actual_volume,
                rated_flat_amount
           FROM udr_lt                     r,
                tbix_bscs_parameter_detail tp
          WHERE to_char(r.tariff_info_sncode) = tp.vl_bscs_parameter -- IN (29, 30)
            AND tp.cd_bscs_parameter = 'RADIO_CDR'
            AND trunc(start_time_timestamp) >= trunc(p_cut_off_date_ini)
            AND trunc(start_time_timestamp) <= trunc(p_cut_off_date_fin)
            AND r.cust_info_contract_id = v_co_id
            AND r.cust_info_customer_id = v_customer_id
            AND call_type = 1
          ORDER BY start_time_timestamp;

   EXCEPTION
      WHEN no_data_found THEN
         NULL;
      WHEN OTHERS THEN
         RAISE;

   END pbix_cursor_02;
   ---------------------------------------------------------
   -- Rogério - 25/05/2012
   -- TS614 / D738 - v2
   ---------------------------------------------------------
   -- Cynthia Kiraly   31/05/2012   FS073.TS526.D760
   -- Inclusão do parâmetro de retorno Tipo de Conta (p_tp_conta)
   ---------------------------------------------------------------
   PROCEDURE pbix_select_ppa_04(p_dn_num     IN directory_number.dn_num%TYPE,
                                p_technology OUT bix.tbix_bscs_parameter_detail.cd_bscs_parameter%TYPE,
                                p_tp_conta   OUT VARCHAR2) IS

   BEGIN

      WITH qry_max AS
       (SELECT tmcode,
               MAX(vscode) AS vscode
          FROM mputmtab
         WHERE status = 'P'
         GROUP BY tmcode)
      SELECT CASE
                WHEN bpd.cd_bscs_parameter = 'TECNOLOGY_2G' THEN
                 '2G'
                WHEN bpd.cd_bscs_parameter = 'TECNOLOGY_3G' THEN
                 '3G'
                ELSE
                 bpd.cd_bscs_parameter
             END technology,
             decode(tm.ats_prepaid_ind, 'N', 'POSPAID', 'P', 'PREPAID', 'M', 'MIXED') tp_conta
        INTO p_technology,
             p_tp_conta
        FROM directory_number           dn,
             contr_services_cap         csc,
             contract_all               co,
             mputmtab                   tm,
             qry_max                    mx,
             tbix_bscs_parameter_detail bpd
       WHERE dn.dn_num = p_dn_num
         AND csc.dn_id = dn.dn_id
         AND csc.main_dirnum = 'X'
         AND csc.cs_activ_date IS NOT NULL
         AND csc.cs_deactiv_date IS NULL
         AND co.co_id = csc.co_id
         AND tm.tmcode = co.tmcode
         AND tm.tmcode = mx.tmcode
         AND tm.vscode = mx.vscode
         AND tm.status = 'P'
         AND bpd.vl_bscs_parameter = co.subm_id
         AND bpd.cd_bscs_parameter IN ('TECNOLOGY_3G', 'TECNOLOGY_2G');

   EXCEPTION
      WHEN OTHERS THEN
         RAISE;
   END pbix_select_ppa_04;

   PROCEDURE pbix_select_ppa_05(p_dn_num     IN directory_number.dn_num%TYPE,
                                p_cursor     OUT type_cursor) IS
   BEGIN

      OPEN p_cursor FOR
        select bc.billcycle, cu.custcode, tm.tmcode rateplan_id, tm.shdes rateplan_code, tm.des rateplan_desc, tm.vscode rateplan_version, co.co_id,
          (select dn_num from directory_number d, pr_serv_status_hist h, contr_services_cap s
           where d.dn_id = s.dn_id and s.cs_deactiv_date is null and s.cs_activ_date is not null
           and h.co_id = s.co_id and h.profile_id = s.profile_id and h.sncode = s.sncode and h.status='A'
           and h.histno = (select max(histno) from pr_serv_status_hist where co_id = s.co_id and sncode = s.sncode and profile_id = s.profile_id)
           and s.co_id = co.co_id and dirnum_npcode = 89) ufmi
        from customer_bch bc, customer_all cu, mputmtab tm, contract_all co, contr_services_cap cs, directory_number dn
        where bc.customer_id = cu.customer_id
        and cu.customer_id = co.customer_id
        and tm.tmcode = co.tmcode and tm.status = 'P'
        and co.co_id = cs.co_id
        and cs.dn_id = dn.dn_id and cs.main_dirnum = 'X' and cs.cs_deactiv_date is null and cs.cs_activ_date is not null
        and dn.dn_num = p_dn_num;

   EXCEPTION
      WHEN OTHERS THEN
         RAISE;

   END pbix_select_ppa_05;

   ---------------------------------------------------------
   --   30/05/2012   <Cynthia Kiraly>   FS073.TS576.D751
   --   Function fbix_return_tmcode criada para
   --   atender a especificação TS576
   ---------------------------------------------------------
   FUNCTION fbix_return_tmcode(p_dn_num IN VARCHAR2) RETURN NUMBER IS

      p_tmcode NUMBER;

   BEGIN

      SELECT rtp.tmcode
        INTO p_tmcode
        FROM sysadm.rateplan           rtp,
             sysadm.contract_all       cta,
             sysadm.contr_services_cap csp,
             sysadm.directory_number   dnb
       WHERE rtp.ats_prepaid_ind != 'N'
         AND rtp.tmcode = cta.tmcode
         AND cta.co_id = csp.co_id
         AND nvl(csp.cs_deactiv_date, SYSDATE) = nvl((SELECT MAX(nvl(c.cs_deactiv_date, SYSDATE))
                                                       FROM sysadm.contr_services_cap c
                                                      WHERE c.dn_id = csp.dn_id),
                                                     SYSDATE)
         AND csp.dn_id = dnb.dn_id
         AND dnb.dn_num = p_dn_num;

      RETURN(p_tmcode);

   EXCEPTION
      WHEN OTHERS THEN
         RAISE;

   END fbix_return_tmcode;

END kbix_java_ppa;



1 linha selecionada.

17:08:32 PNXTL08.IT_PNET3>spool off;
