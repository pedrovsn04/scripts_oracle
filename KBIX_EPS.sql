18:18:31 PNXTL08.IT_PNET3>select dbms_metadata.get_ddl('PACKAGE','KBIX_EPS','BIX') from dual;

DBMS_METADATA.GET_DDL('PACKAGE','KBIX_EPS','BIX')
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

  CREATE OR REPLACE PACKAGE "BIX"."KBIX_EPS" IS

   -- Author  : Fernando R Galha
   -- Created : 11/06/2012 10:11:07
   -- Purpose : Package used by EPS
   ------------------------------------------------------------------------------------------------------
   -- ALTERADO  : Romilda Rosa
   -- DATA      : 16/08/2012
   -- PROJETO   : 3G Project - TS000757/D000925
   -- OBJETIVO  : Criacao da procedure pbix_get_customer_by_phone
   -------------------------------------------------------------------------------------------------------
   -- ALTERADO  : Rogério Iaquinto
   -- DATA      : 28/08/2012
   -- PROJETO   : 3G Project - TS000799/D000941
   -- OBJETIVO  : Criacao da procedure pbix_find_charge_prepeid
   -------------------------------------------------------------------------------------------------------
   -- CRIACAO   : Cynthia Kiraly
   -- DATA      : 11/09/2012
   -- PROJETO   : 3G Project - TS000806/D000955
   -- OBJETIVO  : Retornar os dados cadastrais do cliente a partir do numero do contrato
   ------------------------------------------------------------------------------------------------------
   -- ALTERAÇÃO : Rogério Iaquinto
   -- DATA      : 01/10/2012
   -- PROJETO   : 3G Project - TS000808/D000967
   -- OBJETIVO  : Na pbix_get_customer_by_contract Acrescentar campo cu.customer_id no cursor
   -------------------------------------------------------------------------------------------------------
   -- ALTERAÇÃO : Rogério Iaquinto
   -- DATA      : 01/10/2012
   -- PROJETO   : 3G Project - TS000808/D000967
   -- OBJETIVO  : Na pbix_find_directory_number Acrescentar campo csc.cs_activ_date,dn.dn_status no cursor
   ------------------------------------------------------------------------------------------------------
   -- ALTERAÇÃO : Rogério Iaquinto
   -- DATA      : 01/10/2012
   -- PROJETO   : 3G Project - TS000808/D000967
   -- OBJETIVO  : Criação de procedures
   ------------------------------------------------------------------------------------------------------
   -- ALTERAÇÃO : Ricardo F. de Araújo
   -- DATA      : 11/10/2012
   -- PROJETO   : 3G Project - TS000820/D000978
   -- OBJETIVO  : Criação de procedures / ROTINA DIÁRIA CONTROL-M
   ------------------------------------------------------------------------------------------------------
   -- ALTERAÇÃO : Ricardo F. de Araújo
   -- DATA      : 12/10/2012
   -- PROJETO   : 3G Project - TS000820/D000978
   -- OBJETIVO  : Criação de procedures p_bix_get_contract_by_dnnum
   ------------------------------------------------------------------------------------------------------
   -- ALTERAÇÃO : Ricardo F. de Araújo
   -- DATA      : 12/10/2012
   -- PROJETO   : 3G Project - TS000820/D000978
   -- OBJETIVO  : Criação de procedures p_bix_get_mpulktmb_by_tmcode
   ------------------------------------------------------------------------------------------------------
   -- ALTERAÇÃO : Carlos Miyano
   -- DATA      : 14/01/2013
   -- PROJETO   : 3G Project - TS001000/D001127
   -- OBJETIVO  : Alterado para atender desenvolvimento D001127
   ------------------------------------------------------------------------------------------------------
   -- ALTERAÇÃO : Coelho, Ricardo
   -- DATA      : 12/11/2013
   -- PROJETO   : SCR 00494 - Roaming Internacional - Fase 2
   -- OBJETIVO  : incluido 3 procedures para atender o EPS
   ------------------------------------------------------------------------------------------------------
   -- ALTERADO:   Rogério Iaqunto
   -- DATA:       18/11/2013
   -- PROJETO   : SCR 00494 - Roaming Internacional - Fase 2
   -- OBJETIVO:   Retirar parametros de retorno e mensagem na proc pbix_get_free_unit_assignment
   ------------------------------------------------------------------------------------------------------
   -- ALTERADO:   Coelho, Ricardo
   -- DATA:       17/01/2014
   -- PROJETO   : SCR 00703 - Siga-me
   -- OBJETIVO:   Criado a procedure para retornar o código magnus do cliente
   ------------------------------------------------------------------------------------------------------
   -- ALTERADO:   Romilda Rosa
   -- DATA:       06/02/2014
   -- PROJETO   : SCR 00703 - Siga-me
   -- OBJETIVO:   Alteracoes na pbix_get_inf_contract
   -----------------------------------------------------------------------------------------------
   ------------------------------------------------------------------------------------------------------
   -- ALTERADO:   Leo Arai
   -- DATA:       07/02/2014 ~ 28/05/2014
   -- PROJETO   : SCR 00703 - Siga-me
   -- OBJETIVO:   Criação da pbix_upd_quarentena_sigame-atualiza quarentena do nº 2G  / Parametrização RADIO_3G
   -----------------------------------------------------------------------------------------------

   TYPE resultset IS REF CURSOR;

   TYPE typ_mdsrrtab IS RECORD(
      request INTEGER,
      status  INTEGER);

   TYPE typ_tb_mdsrrtab IS TABLE OF typ_mdsrrtab;

   g_error_code         NUMBER(5);
   g_error_message      VARCHAR2(4000);
   g_check_point				NUMBER(5);

   PROCEDURE pbix_find_req_creation_date(p_cd_request IN sysadm.mdsrrtab_hist.request%TYPE,
                                         p_cursor     OUT resultset);

   PROCEDURE pbix_read_contract_rateplanid(p_cd_contract IN sysadm.contract_all.co_id%TYPE,
                                           p_cursor      OUT resultset);

   PROCEDURE pbix_find_customerid(p_cd_contract IN sysadm.contract_all.co_id%TYPE,
                                  p_cursor      OUT resultset);

   PROCEDURE pbix_find_directory_number(p_cd_contract    IN sysadm.contr_services_cap.co_id%TYPE,
                                        p_numbering_plan IN sysadm.directory_number.dirnum_npcode%TYPE,
                                        p_cursor         OUT resultset);

   PROCEDURE pbix_find_new_directory_number(p_cd_contract    IN sysadm.contr_services_cap.co_id%TYPE,
                                            p_numbering_plan IN sysadm.directory_number.dirnum_npcode%TYPE,
                                            p_cursor         OUT resultset);

   PROCEDURE pbix_read_contract_services(p_cd_contract IN sysadm.pr_serv_status_hist.co_id%TYPE,
                                         p_cd_request  IN sysadm.pr_serv_status_hist.request_id%TYPE,
                                         p_cursor      OUT resultset);

   PROCEDURE pbix_read_contract_services(p_cd_contract IN sysadm.pr_serv_status_hist.co_id%TYPE,
                                         p_cursor      OUT resultset);

   PROCEDURE pbix_find_suspension_date(p_cd_contract_id IN sysadm.contract_history.co_id%TYPE,
                                       p_cd_request_id  IN sysadm.contract_history.request%TYPE,
                                       p_cursor         OUT resultset);

   PROCEDURE pbix_get_customer_by_phone(p_dn_num IN sysadm.directory_number.dn_num%TYPE,
                                        p_cursor OUT resultset);

   PROCEDURE pbix_get_customer_by_contract(p_co_id  IN sysadm.contract_all.co_id%TYPE,
                                           p_cursor OUT resultset);

   PROCEDURE pbix_find_charge_prepaid(p_co_id  IN bix.contract_all.co_id%TYPE,
                                      p_cursor OUT resultset);

   PROCEDURE pbix_find_sm_serialnum_act(p_co_id  IN contr_devices.co_id%TYPE,
                                        p_cursor OUT resultset);

   PROCEDURE pbix_find_sm_serialnum_deact(p_co_id  IN contr_devices.co_id%TYPE,
                                          p_cursor OUT resultset);

   PROCEDURE pbix_find_port_num_act(p_co_id  IN contr_devices.co_id%TYPE,
                                    p_cursor OUT resultset);

   PROCEDURE pbix_find_port_num_deact(p_co_id  IN contr_devices.co_id%TYPE,
                                      p_cursor OUT resultset);

   PROCEDURE pbix_find_dn_num(p_co_id         IN contr_services_cap.co_id%TYPE,
                              p_dirnum_npcode IN directory_number.dirnum_npcode%TYPE,
                              p_cursor        OUT resultset);

   PROCEDURE pbix_find_custcode(p_co_id  IN contract_all.co_id%TYPE,
                                p_cursor OUT resultset);

   PROCEDURE pbix_find_contract_hist(p_new_contract_id IN contract_takeover_history.new_contract_id%TYPE,
                                     p_cursor          OUT resultset);
   -- D000967 -- Início
   -- 2 - obter o CNPJ
   PROCEDURE pbix_get_cnpj(p_co_id  IN contract_all.co_id%TYPE,
                           p_cursor OUT resultset);
   -- 3 - Obter os dados de números de telefone
   PROCEDURE pbix_number_phone(p_co_id  IN contract_all.co_id%TYPE,
                               p_cursor OUT resultset);
   -- 4 - Retorna o nome do Cliente
   PROCEDURE pbix_customer_by_contract(p_co_id  IN contract_all.co_id%TYPE,
                                       p_cursor OUT resultset);
   -- 5 - Obter o IMSI e indicador pré-pago
   PROCEDURE pbix_get_susbcriber_info_imsi(p_co_id  IN contract_all.co_id%TYPE,
                                           p_cursor OUT resultset);
   -- 1 - Ativação e reativação
   PROCEDURE pbix_activation_reactivation(p_co_id  IN contract_all.co_id%TYPE,
                                          p_cursor OUT resultset);
   -- 6 - Último pedido associado
   PROCEDURE pbix_get_last_request_assoc(p_co_id  IN contract_all.co_id%TYPE,
                                         p_cursor OUT resultset);
   -- 7 Obter o identificador do SIMCard
   PROCEDURE pbix_get_simcard_id(p_sm_serialnum IN storage_medium.sm_serialnum%TYPE,
                                 p_cursor       OUT resultset);
   -- 8 - Obter o identificador do equipamento associado ao identificador SIMCard
   PROCEDURE pbix_get_assoc_eq_simcard(p_sm_id  IN resource_link.sm_id%TYPE,
                                       p_cursor OUT resultset);
   -- 9 - Obter o IMEI associado ao equipamento
   PROCEDURE pbix_get_assoc_eq_imei(p_equipment_id IN equipment.equipment_id%TYPE,
                                    p_cursor       OUT resultset);
   -- 10 - Motivo da reativação
   PROCEDURE pbix_get_reason_reactivation(p_co_id  IN contract_history.co_id%TYPE,
                                          p_cursor OUT resultset);
   -- 11 - Consultar a última chamada associada ao contrato e cliente BSCS
   PROCEDURE pbix_last_call_assoc_customer(p_customer_id IN udr_lt.cust_info_customer_id%TYPE,
                                           p_co_id       IN udr_lt.cust_info_contract_id%TYPE,
                                           p_cursor      OUT resultset);
   -- 12 - RECUPERA O REASON DA SUSPENSAO A PARTIR DO NUMERO DO CONTRATO
   PROCEDURE pbix_get_reason_suspension(p_co_id  IN contract_all.co_id%TYPE,
                                        p_cursor OUT resultset);
   -- Sobrecarga
   PROCEDURE pbix_get_reason_suspension(p_co_id   IN contract_history.co_id%TYPE,
                                        p_request IN contract_history.request%TYPE,
                                        p_cursor  OUT resultset);
   -- 13 - Retorna o customer_id
   PROCEDURE p_bix_get_customer_by_custcode(p_custcode IN customer_all.custcode%TYPE,
                                            p_cursor   OUT resultset);
   -- 14 - Retorna o custcode
   PROCEDURE p_bix_get_custcode_by_customer(p_customer_id IN customer_all.customer_id%TYPE,
                                            p_cursor      OUT resultset);
   --   ROTINA DIÁRIA CONTROL-M
   PROCEDURE p_bix_last_cust_process(p_date  IN VARCHAR2,
                                     p_count OUT NUMBER);

   PROCEDURE p_bix_get_contract_by_activ_dt(p_co_id         IN NUMBER,
                                            p_imsi          IN VARCHAR2,
                                            p_cd_activ_date OUT DATE);

   PROCEDURE pbix_get_new_imei_3g(p_date   IN DATE,
                                  p_cursor OUT resultset);

   PROCEDURE p_bix_mpul_cont_by_dnnum(p_dn_num IN VARCHAR2,
                                      p_cursor OUT resultset);

   FUNCTION fbix_mdsrrtab RETURN typ_tb_mdsrrtab
      PIPELINED;

   PROCEDURE p_bix_tbix_prep_rateplan_bund(p_cursor OUT resultset);

   PROCEDURE pbix_contr_nts_bundle(p_cd_contract          IN profile_service.co_id%TYPE,
                                   p_fg_additional_bundle IN tbix_data_service_bundle.fg_additional_bundle%TYPE DEFAULT NULL,
                                   p_cursor               OUT resultset);

   PROCEDURE pbix_get_nts_bundle(p_cursor OUT resultset);

   PROCEDURE pbix_get_free_unit_assignment(	p_cursor					OUT resultset
											                      )	;
   PROCEDURE pbix_get_roaming_international(	p_tmcode				IN		NUMBER			,
												p_spcode				IN		NUMBER			,
												p_sncode				IN		NUMBER			,
												p_fu_pack_id			IN		NUMBER			,
												p_cursor					OUT resultset		,
												p_retorno					OUT	VARCHAR2		,
												p_mensagem					OUT VARCHAR2		)
	;
   PROCEDURE pbix_upd_fees_period	(	p_co_id					IN		NUMBER			,
										p_tmcode				IN		NUMBER			,
										p_spcode				IN		NUMBER			,
										p_sncode				IN		NUMBER			,
										p_fu_pack_id			IN		NUMBER			,
										p_fee_class				IN		NUMBER			,
										p_updrowcount				OUT NUMBER			,
										p_retorno					OUT	VARCHAR2		,
										p_mensagem					OUT VARCHAR2		)
	;

   PROCEDURE pbix_get_inf_contract(p_contract_id   IN  sysadm.contract_all.co_id%TYPE,
                                   p_co_activated  OUT  sysadm.contract_all.co_activated%TYPE,
                                   p_magnus        OUT sysadm.ccontact_all.ccjobdesc%TYPE,
                                   p_custcode      OUT sysadm.customer_all.custcode%TYPE,
                                   p_imei          OUT sysadm.storage_medium.sm_serialnum%TYPE,
                                   p_retorno       OUT VARCHAR2,
                                   p_mensagem      OUT VARCHAR2
                                  )
   ;
   PROCEDURE pbix_get_migra2gto3g(p_co_id         IN sysadm.info_contr_text.co_id%TYPE,
                                  p_cursor        OUT resultset,
  	                              p_retorno	      OUT VARCHAR2,
                                  p_mensagem	  OUT VARCHAR2
                                  )
   ;
   PROCEDURE pbix_upd_quarentena_sigame(p_co_id    IN NUMBER,
                                        p_data     IN DATE,
                                        p_retorno  OUT VARCHAR2,
                                        p_mensagem OUT VARCHAR2
                                  )
   ;
   PROCEDURE pbix_get_msisdn2g(p_co_id       IN NUMBER,
                               p_msisdn      OUT VARCHAR2,
                               p_retorno     OUT VARCHAR2,
                               p_mensagem    OUT VARCHAR2
                                  );

   PROCEDURE pbix_get_data_pooling_info(p_customer_id IN sysadm.customer_all.customer_id%TYPE,
                                        p_cursor OUT resultset);

   PROCEDURE pbix_get_market_services(p_vmd_markets IN t_tab_vmd_market,
                                      p_cursor       OUT resultset);

   PROCEDURE pbix_get_contract_reason(p_co_id  IN NUMBER,
                                      p_cursor OUT resultset);

END KBIX_EPS;
CREATE OR REPLACE PACKAGE BODY "BIX"."KBIX_EPS" IS

   -- Author  : Fernando R Galha / Lauren Maran
   -- Created : 11/06/2012 10:11:07
   -- Purpose : Package used by EPS

   PROCEDURE pbix_find_req_creation_date(p_cd_request IN sysadm.mdsrrtab_hist.request%TYPE,
                                         p_cursor     OUT resultset) IS
   BEGIN
      OPEN p_cursor FOR
         SELECT insert_date
           FROM mdsrrtab_hist
          WHERE request = p_cd_request
            AND seqno = 1;
   END;

   PROCEDURE pbix_read_contract_rateplanid(p_cd_contract IN sysadm.contract_all.co_id%TYPE,
                                           p_cursor      OUT resultset) IS
   BEGIN
      OPEN p_cursor FOR
         SELECT tmcode FROM contract_all WHERE co_id = p_cd_contract;
   END;

   PROCEDURE pbix_find_customerid(p_cd_contract IN sysadm.contract_all.co_id%TYPE,
                                  p_cursor      OUT resultset) IS
   BEGIN
      OPEN p_cursor FOR
         SELECT customer_id FROM contract_all WHERE co_id = p_cd_contract;
   END;

   PROCEDURE pbix_find_directory_number(p_cd_contract    IN sysadm.contr_services_cap.co_id%TYPE,
                                        p_numbering_plan IN sysadm.directory_number.dirnum_npcode%TYPE,
                                        p_cursor         OUT resultset) IS
      ------------------------------------------------------------------------------------------------------
      -- ALTERAÇÃO : Rogério Iaquinto
      -- DATA      : 01/10/2012
      -- PROJETO   : 3G Project - TS000808/D000967
      -- OBJETIVO  : Acrescentar campo csc.cs_activ_date,dn.dn_status no cursor
      ------------------------------------------------------------------------------------------------------

   BEGIN
      OPEN p_cursor FOR
         SELECT dn.dn_num,
                csc.cs_activ_date,
                dn.dn_status
           FROM directory_number   dn,
                contr_services_cap csc

          WHERE csc.co_id = p_cd_contract
            AND dn.dn_id = csc.dn_id
            AND csc.cs_activ_date IS NOT NULL
            AND csc.cs_deactiv_date IS NULL
            AND dn.dirnum_npcode = p_numbering_plan;
   END;

   PROCEDURE pbix_find_new_directory_number(p_cd_contract    IN sysadm.contr_services_cap.co_id%TYPE,
                                            p_numbering_plan IN sysadm.directory_number.dirnum_npcode%TYPE,
                                            p_cursor         OUT resultset) IS
   BEGIN
      OPEN p_cursor FOR
         SELECT dn.dn_num,
                csc.cs_activ_date
           FROM sysadm.directory_number dn,
                contr_services_cap      csc
          WHERE csc.co_id = p_cd_contract
            AND dn.dn_id = csc.dn_id
            AND csc.cs_activ_date IS NULL
            AND csc.cs_deactiv_date IS NULL
            AND dn.dirnum_npcode = p_numbering_plan
          ORDER BY csc.cs_activ_date DESC;
   END;

   PROCEDURE pbix_read_contract_services(p_cd_contract IN sysadm.pr_serv_status_hist.co_id%TYPE,
                                         p_cd_request  IN sysadm.pr_serv_status_hist.request_id%TYPE,
                                         p_cursor      OUT resultset) IS
   BEGIN
      OPEN p_cursor FOR
         SELECT sncode
           FROM pr_serv_status_hist
          WHERE co_id = p_cd_contract
            AND request_id = p_cd_request;
   END;

   PROCEDURE pbix_read_contract_services(p_cd_contract IN sysadm.pr_serv_status_hist.co_id%TYPE,
                                         p_cursor      OUT resultset) IS
   BEGIN
      OPEN p_cursor FOR
         SELECT h.sncode
           FROM pr_serv_status_hist h,
                profile_service     s
          WHERE s.status_histno = h.histno
            AND h.co_id = s.co_id
            AND s.co_id = p_cd_contract
            AND status = 'A';
   END;

   PROCEDURE pbix_find_suspension_date(p_cd_contract_id IN sysadm.contract_history.co_id%TYPE,
                                       p_cd_request_id  IN sysadm.contract_history.request%TYPE,
                                       p_cursor         OUT resultset) IS
   BEGIN
      OPEN p_cursor FOR
         SELECT trunc(ch_a.ch_validfrom) - trunc(ch_s.ch_validfrom)
           FROM sysadm.contract_history ch_s,
                sysadm.contract_history ch_a
          WHERE ch_a.co_id = p_cd_contract_id
            AND ch_a.request = p_cd_request_id
            AND ch_s.ch_seqno = ch_a.ch_seqno - 1
            AND ch_s.co_id = ch_a.co_id;
   END;

   PROCEDURE pbix_get_customer_by_phone(p_dn_num IN sysadm.directory_number.dn_num%TYPE,
                                        p_cursor OUT resultset) IS
      ------------------------------------------------------------------------------------------------------
      -- CRIACAO   : Romilda Rosa
      -- DATA      : 16/08/2012
      -- PROJETO   : 3G Project - TS000757/D000925
      -- OBJETIVO  : Retornar os dados cadastrais do cliente a partir do numero de telefone passado como para
      --             metro.
      -------------------------------------------------------------------------------------------------------
      -- ALTERADO  :
      -- DATA      :
      -- PROJETO   :
      -- OBJETIVO  :
      -------------------------------------------------------------------------------------------------------

   BEGIN
      OPEN p_cursor FOR
         SELECT tm.des "PLANO",
                cc.ccname "CLIENTE",
                decode(length(cc.cssocialsecno), 11, NULL, cc.ccfname) "CONTATO",
                substr(cc.ccaddr2, 1, instr(cc.ccaddr2, ',', 1, 1) - 1) "RUA",
                substr(cc.ccaddr2, instr(cc.ccaddr2, ',', 1, 1) + 1) "NUMERO",
                cc.ccaddr3 "COMPLEMENTO",
                cc.ccstreet "BAIRRO",
                cc.cccity "CIDADE",
                cc.ccstate "UF",
                cc.cczip "CEP",
                cc.cssocialsecno "CNPJ_CPF",
                cu.customer_id "CODIGO_CLIENTE",
                cu.custcode "CENTRO_CUSTO",
                cu.costcenter_id "CODIGO_MERCADO",
                REPLACE(upper(c.cost_desc), 'CIDADE', '') || ' - ' || tcj.jurdic_code "NOME_MERCADO",
                co.co_id "CONTRATO"
           FROM tbix_costcenter_jurisdiction tcj,
                costcenter                   c,
                mputmtab                     tm,
                directory_number             dn,
                contr_services_cap           csc,
                contract_all                 co,
                customer_all                 cu,
                ccontact_all                 cc
          WHERE dn.dn_num = p_dn_num
            AND csc.dn_id = dn.dn_id
            AND co.co_id = csc.co_id
            AND csc.cs_activ_date IS NOT NULL
            AND csc.cs_deactiv_date IS NULL
            AND csc.main_dirnum = 'X'
            AND cu.customer_id = co.customer_id
            AND cc.customer_id = co.customer_id
            AND cc.ccbill = 'X'
            AND tm.tmcode = co.tmcode
            AND tm.vscode = (SELECT MAX(tm2.vscode) FROM mputmtab tm2 WHERE tm2.tmcode = tm.tmcode)
            AND c.cost_id = cu.costcenter_id
            AND tcj.cost_id = c.cost_id;
   END;

   ------------------------------------------------------------------------------------------------------
   -- CRIACAO   : Cynthia Kiraly
   -- DATA      : 11/09/2012
   -- PROJETO   : 3G Project - TS000806/D000955
   -- OBJETIVO  : Retornar os dados cadastrais do cliente a partir do numero do contrato

   PROCEDURE pbix_get_customer_by_contract(p_co_id  IN sysadm.contract_all.co_id%TYPE,
                                           p_cursor OUT resultset) IS
      ------------------------------------------------------------------------------------------------------
      -- ALTERAÇÃO : Rogério Iaquinto
      -- DATA      : 01/10/2012
      -- PROJETO   : 3G Project - TS000808/D000967
      -- OBJETIVO  : Acrescentar campo cu.customer_id no cursor
      ------------------------------------------------------------------------------------------------------

   BEGIN
      OPEN p_cursor FOR
         SELECT cc.ccname,
                cc.cssocialsecno,
                cu.custcode,
                cu.customer_id
           FROM contract_all co,
                customer_all cu,
                ccontact_all cc
          WHERE co.co_id = p_co_id
            AND cu.customer_id = co.customer_id
            AND cc.customer_id = co.customer_id
            AND cc.ccbill = 'X';
   END;

   PROCEDURE pbix_find_charge_prepaid(p_co_id  IN bix.contract_all.co_id%TYPE,
                                      p_cursor OUT resultset)

    IS
      -------------------------------------------------------------------------------------------------------
      -- ALTERADO  : Rogério Iaquinto
      -- DATA      : 28/08/2012
      -- PROJETO   : 3G Project - TS000799/D000941
      -- OBJETIVO  : Criacao da procedure pbix_find_charge_prepaid
      -------------------------------------------------------------------------------------------------------
   BEGIN
      OPEN p_cursor FOR

         SELECT msn.des,
                pssh.valid_from_date,
                mlk.accessfee
           FROM contract_all        ca,
                profile_service     ps,
                pr_serv_status_hist pssh,
                mpulktmb            mlk,
                mpusntab            msn
          WHERE ca.co_id = p_co_id
            AND mlk.status = 'P'
            AND pssh.status = 'A'
            AND ca.tmcode = mlk.tmcode
            AND mlk.sncode = ps.sncode
            AND ca.co_id = ps.co_id
            AND ps.co_id = pssh.co_id
            AND ps.sncode = pssh.sncode
            AND ps.sncode = msn.sncode
            AND ps.status_histno = pssh.histno
            AND msn.sncode IN (SELECT to_number(bpd.vl_bscs_parameter)
                                 FROM bix.tbix_bscs_parameter_detail bpd
                                WHERE bpd.cd_bscs_parameter = 'CHARGE_PREPAID')
            AND mlk.vscode = (SELECT MAX(m.vscode) FROM mpulktmb m WHERE m.tmcode = ca.tmcode);

   END pbix_find_charge_prepaid;

   /*
   Procedures 30/08/2012
   */
   PROCEDURE pbix_find_sm_serialnum_act(p_co_id  IN contr_devices.co_id%TYPE,
                                        p_cursor OUT resultset)

    IS
   BEGIN

      OPEN p_cursor FOR
         SELECT sm.sm_serialnum
           FROM storage_medium sm,
                contr_devices  cd
          WHERE sm.sm_serialnum = cd.cd_sm_num
            AND cd.co_id = p_co_id
            AND cd.cd_deactiv_date IS NULL;

   END pbix_find_sm_serialnum_act;

   PROCEDURE pbix_find_sm_serialnum_deact(p_co_id  IN contr_devices.co_id%TYPE,
                                          p_cursor OUT resultset)

    IS

   BEGIN
      OPEN p_cursor FOR
         SELECT sm.sm_serialnum
           FROM storage_medium sm,
                contr_devices  cd
          WHERE sm.sm_serialnum = cd.cd_sm_num
            AND cd.co_id = p_co_id
            AND cd.cd_deactiv_date IS NOT NULL
          ORDER BY cd.cd_deactiv_date DESC;

   END pbix_find_sm_serialnum_deact;

   PROCEDURE pbix_find_port_num_act(p_co_id  IN contr_devices.co_id%TYPE,
                                    p_cursor OUT resultset) IS

   BEGIN
      OPEN p_cursor FOR
         SELECT p.port_num
           FROM port          p,
                contr_devices cd
          WHERE p.port_id = cd.port_id
            AND cd.co_id = p_co_id
            AND cd.cd_deactiv_date IS NULL;

   END pbix_find_port_num_act;

   PROCEDURE pbix_find_port_num_deact(p_co_id  IN contr_devices.co_id%TYPE,
                                      p_cursor OUT resultset) IS

   BEGIN
      OPEN p_cursor FOR
         SELECT p.port_num
           FROM port          p,
                contr_devices cd
          WHERE p.port_id = cd.port_id
            AND cd.co_id = p_co_id
            AND cd.cd_deactiv_date IS NOT NULL
          ORDER BY cd.cd_deactiv_date DESC;

   END pbix_find_port_num_deact;

   PROCEDURE pbix_find_dn_num(p_co_id         IN contr_services_cap.co_id%TYPE,
                              p_dirnum_npcode IN directory_number.dirnum_npcode%TYPE,
                              p_cursor        OUT resultset) IS
      -------------------------------------------------------------------------------------------------------
      -- ALTERADO  : Emiliano Trapp
      -- DATA      : 26/07/2013
      -- PROJETO   :
      -- OBJETIVO  : Correcao para buscar telefone ordenado pelo ultimo telefone em uso pelo contrato
      -------------------------------------------------------------------------------------------------------
   BEGIN

      OPEN p_cursor FOR
         SELECT dn.dn_num
           FROM directory_number   dn,
                contr_services_cap csc
          WHERE csc.co_id = p_co_id
            AND dn.dn_id = csc.dn_id
            AND csc.cs_activ_date IS NOT NULL
            AND dn.dirnum_npcode = p_dirnum_npcode
          ORDER BY csc.seqno DESC;

   END pbix_find_dn_num;

   PROCEDURE pbix_find_custcode(p_co_id  IN contract_all.co_id%TYPE,
                                p_cursor OUT resultset) IS

   BEGIN
      OPEN p_cursor FOR
         SELECT ca.custcode
           FROM customer_all ca,
                contract_all cont
          WHERE ca.customer_id = cont.customer_id
            AND cont.co_id = p_co_id;

   END pbix_find_custcode;

   PROCEDURE pbix_find_contract_hist(p_new_contract_id IN contract_takeover_history.new_contract_id%TYPE,
                                     p_cursor          OUT resultset)

    IS

   BEGIN
      OPEN p_cursor FOR
         SELECT t.contract_takeover_history_id,
                t.old_customer_id,
                t.old_contract_id,
                t.new_customer_id,
                t.new_contract_id
           FROM contract_takeover_history t
          WHERE t.new_contract_id = p_new_contract_id;

   END pbix_find_contract_hist;

   ------------------------------------------------------------------------------------------------------
   -- ALTERAÇÃO : Rogério Iaquinto
   -- DATA      : 01/10/2012
   -- PROJETO   : 3G Project - TS000808/D000967
   -- OBJETIVO  : Descrito no inicio de cada proc
   -------------------------------------------------------------------------------------------------------
   -- 2 - obter o CNPJ
   PROCEDURE pbix_get_cnpj(p_co_id  IN contract_all.co_id%TYPE,
                           p_cursor OUT resultset) IS

   BEGIN
      OPEN p_cursor FOR
         SELECT csa.customer_id,
                csa.cssocialsecno
           FROM customer_all csa,
                contract_all cta
          WHERE cta.co_id = p_co_id
            AND csa.customer_id = cta.customer_id;

   END pbix_get_cnpj;

   -- 3 - Obter os dados de números de telefone
   PROCEDURE pbix_number_phone(p_co_id  IN contract_all.co_id%TYPE,
                               p_cursor OUT resultset) IS

   BEGIN
      OPEN p_cursor FOR
         SELECT dn.dn_num,
                decode(dn.dn_status, 'i', '1', '0') dn_status,
                cap.cs_activ_date,
                cap.cs_deactiv_date
           FROM directory_number   dn,
                contr_services_cap cap,
                contract_all       cta
          WHERE cap.main_dirnum = 'X'
            AND cta.co_id = p_co_id
            AND dn.dn_id = cap.dn_id
            AND cap.co_id = cta.co_id;

   END pbix_number_phone;

   -- 4 - Retorna o nome do Cliente
   PROCEDURE pbix_customer_by_contract(p_co_id  IN contract_all.co_id%TYPE,
                                       p_cursor OUT resultset) IS

   BEGIN
      OPEN p_cursor FOR
         SELECT cca.ccline2
           FROM ccontact_all cca,
                customer_all csa,
                contract_all cta
          WHERE cta.co_id = p_co_id
            AND cta.customer_id = csa.customer_id
            AND cta.customer_id = cca.customer_id
            AND cca.ccbill = 'X';

   END pbix_customer_by_contract;

   -- 5 - Obter o IMSI e indicador pré-pago
   PROCEDURE pbix_get_susbcriber_info_imsi(p_co_id  IN contract_all.co_id%TYPE,
                                           p_cursor OUT resultset) IS

   BEGIN
      OPEN p_cursor FOR
         SELECT prt.port_num,
                decode(mpu.ats_prepaid_ind, 'N', 0, 'P', 1, 'M', 2) ats_prepaid_ind
           FROM mputmtab      mpu,
                port          prt,
                contract_all  co,
                contr_devices ctd
          WHERE co.co_id = p_co_id
            AND co.tmcode = mpu.tmcode
            AND co.co_id = ctd.co_id
            AND prt.port_id = ctd.port_id
            AND mpu.vscode = (SELECT MAX(vscode)
                                FROM mputmtab
                               WHERE tmcode = mpu.tmcode
                                 AND status = 'P')
            AND mpu.status = 'P'
            AND ctd.cd_deactiv_date IS NULL;

   END pbix_get_susbcriber_info_imsi;

   -- 1 - Ativação e reativação
   PROCEDURE pbix_activation_reactivation(p_co_id  IN contract_all.co_id%TYPE,
                                          p_cursor OUT resultset) IS
      -- Se MAX(ch_seqno) > 2 = REATIVAÇÃO
      -- Se MAX(ch_seqno) <= 2 = ATIVAÇÃO
   BEGIN
      OPEN p_cursor FOR
         SELECT MAX(ch_seqno) FROM contract_history cth WHERE cth.co_id = p_co_id;

   END pbix_activation_reactivation;

   -- 6 - Último pedido associado
   PROCEDURE pbix_get_last_request_assoc(p_co_id  IN contract_all.co_id%TYPE,
                                         p_cursor OUT resultset) IS

   BEGIN

      OPEN p_cursor FOR
         SELECT ctd.cd_sm_num,
                ctd.port_id
           FROM contr_devices ctd
          WHERE ctd.co_id = p_co_id
            AND ctd.cd_validfrom =
                (SELECT MAX(cd.cd_validfrom) FROM contr_devices cd WHERE cd.co_id = p_co_id);

   END pbix_get_last_request_assoc;

   -- 7 Obter o identificador do SIMCard
   PROCEDURE pbix_get_simcard_id(p_sm_serialnum IN storage_medium.sm_serialnum%TYPE,
                                 p_cursor       OUT resultset) IS
   BEGIN
      OPEN p_cursor FOR
         SELECT sm_id FROM storage_medium sm WHERE sm.sm_serialnum = p_sm_serialnum;
   END pbix_get_simcard_id;

   -- 8 - Obter o identificador do equipamento associado ao identificador SIMCard
   PROCEDURE pbix_get_assoc_eq_simcard(p_sm_id  IN resource_link.sm_id%TYPE,
                                       p_cursor OUT resultset) IS
   BEGIN
      OPEN p_cursor FOR
         SELECT equipment_id FROM resource_link rl WHERE rl.sm_id = p_sm_id;
   END pbix_get_assoc_eq_simcard;

   -- 9 - Obter o IMEI associado ao equipamento
   PROCEDURE pbix_get_assoc_eq_imei(p_equipment_id IN equipment.equipment_id%TYPE,
                                    p_cursor       OUT resultset) IS

   BEGIN
      OPEN p_cursor FOR
         SELECT imei FROM equipment WHERE equipment_id = p_equipment_id;

   END pbix_get_assoc_eq_imei;

   -- 10 - Motivo da reativação
   PROCEDURE pbix_get_reason_reactivation(p_co_id  IN contract_history.co_id%TYPE,
                                          p_cursor OUT resultset) IS

   BEGIN
      OPEN p_cursor FOR
         SELECT cth.ch_reason,
                cth.ch_validfrom
           FROM contract_history cth
          WHERE cth.co_id = p_co_id
            AND cth.ch_seqno =
                (SELECT MAX(a.ch_seqno) FROM contract_history a WHERE a.co_id = cth.co_id);
   END pbix_get_reason_reactivation;

   -- TS000809
   -- 11 - Consultar a última chamada associada ao contrato e cliente BSCS
   PROCEDURE pbix_last_call_assoc_customer(p_customer_id IN udr_lt.cust_info_customer_id%TYPE,
                                           p_co_id       IN udr_lt.cust_info_contract_id%TYPE,
                                           p_cursor      OUT resultset) IS
   BEGIN
      OPEN p_cursor FOR
         SELECT MAX(a.start_time_timestamp) start_time_timestamp,
                a.s_p_equipment_number
           FROM udr_lt a
          WHERE a.cust_info_customer_id = p_customer_id
            AND a.cust_info_contract_id = p_co_id
          GROUP BY a.s_p_equipment_number;

   END pbix_last_call_assoc_customer;

   -- 12 - RECUPERA O REASON DA SUSPENSAO A PARTIR DO NUMERO DO CONTRATO
   PROCEDURE pbix_get_reason_suspension(p_co_id  IN contract_all.co_id%TYPE,
                                        p_cursor OUT resultset) IS
   BEGIN
      OPEN p_cursor FOR
         SELECT ch.ch_reason
           FROM contract_all     ca,
                contract_history ch
          WHERE ca.ch_status = 's'
            AND ca.co_id = ch.co_id
            AND ch.ch_validfrom =
                (SELECT MAX(chi.ch_validfrom) FROM contract_history chi WHERE chi.co_id = p_co_id)
            AND ca.co_id = p_co_id;

   END pbix_get_reason_suspension;

   -- Sobrecarga
   PROCEDURE pbix_get_reason_suspension(p_co_id   IN contract_history.co_id%TYPE,
                                        p_request IN contract_history.request%TYPE,
                                        p_cursor  OUT resultset) IS
   BEGIN
      OPEN p_cursor FOR
         SELECT o.ch_reason    AS ch_reason_old,
                n.ch_reason    ch_reason,
                n.ch_validfrom
           FROM contract_history n,
                contract_history o
          WHERE n.request = p_request
            AND n.co_id = p_co_id
            AND n.co_id = o.co_id
            AND o.ch_seqno = n.ch_seqno - 1;

   END pbix_get_reason_suspension;

   -- 13 - Retorna o customer_id
   PROCEDURE p_bix_get_customer_by_custcode(p_custcode IN customer_all.custcode%TYPE,
                                            p_cursor   OUT resultset) IS
   BEGIN
      OPEN p_cursor FOR
         SELECT customer_id FROM customer_all ca WHERE custcode = p_custcode;

   END p_bix_get_customer_by_custcode;

   -- 14 - Retorna o custcode
   PROCEDURE p_bix_get_custcode_by_customer(p_customer_id IN customer_all.customer_id%TYPE,
                                            p_cursor      OUT resultset) IS
   BEGIN
      OPEN p_cursor FOR
         SELECT custcode FROM customer_all ca WHERE ca.customer_id = p_customer_id;

   END p_bix_get_custcode_by_customer;

   --   ROTINA DIÁRIA CONTROL-M
   PROCEDURE p_bix_last_cust_process(p_date  IN VARCHAR2,
                                     p_count OUT NUMBER) IS
   BEGIN
      BEGIN
         SELECT COUNT(1)
           INTO p_count
           FROM sysadm.equipment eq
          WHERE eq.eq_entdate = to_date(p_date, 'DD/MM/YYYY H24:MI:SS')
            AND eq.eq_status IN ('f', 'r');
      EXCEPTION
         WHEN no_data_found THEN
            p_count := 0;
      END;
   END p_bix_last_cust_process;

   PROCEDURE p_bix_get_contract_by_activ_dt(p_co_id IN NUMBER,
                                            p_imsi  IN VARCHAR2

                                           ,
                                            p_cd_activ_date OUT DATE) IS
   BEGIN
      BEGIN
         SELECT ctd.cd_activ_date
           INTO p_cd_activ_date
           FROM contr_devices ctd,
                port          prt
          WHERE ctd.cd_deactiv_date IS NULL
            AND ctd.co_id = p_co_id
            AND prt.port_num = p_imsi
            AND ctd.port_id = prt.port_id;
      EXCEPTION
         WHEN no_data_found THEN
            p_cd_activ_date := NULL;
      END;
   END p_bix_get_contract_by_activ_dt;

   PROCEDURE pbix_get_new_imei_3g(p_date   IN DATE,
                                  p_cursor OUT resultset) IS
   BEGIN
      OPEN p_cursor FOR
         SELECT imei,
                eq_entdate
           FROM sysadm.equipment eq
          WHERE eq.eq_entdate > p_date
            AND eq.eq_status IN ('f', 'r')
          ORDER BY eq.eq_entdate;

   END pbix_get_new_imei_3g;

   PROCEDURE p_bix_mpul_cont_by_dnnum(p_dn_num IN VARCHAR2,
                                      p_cursor OUT resultset) IS
   BEGIN

      OPEN p_cursor FOR
         SELECT co.co_id,
                co.customer_id,
                cu.custcode,
                co.tmcode,
                tmb.vscode,
                tmb.spcode,
                tmb.sncode,
                tmb.usgglcode,
                tmb.usgserv_catcode,
                tmb.usgserv_code,
                tmb.usgserv_type
           FROM contract_all       co,
                contr_services_cap cs,
                directory_number   dn,
                mpulktmb           tmb,
                mpusntab           sn,
                customer_all       cu
          WHERE co.co_id = cs.co_id
            AND cs.dn_id = dn.dn_id
            AND co.tmcode = tmb.tmcode
            AND sn.sncode = tmb.sncode
            AND cu.customer_id = co.customer_id
            AND sn.shdes = '3DOWN'
            AND cs.main_dirnum = 'X'
            AND cs.cs_activ_date IS NOT NULL
            AND cs.cs_deactiv_date IS NULL
            AND tmb.vscode = (SELECT MAX(vscode)
                                FROM rateplan_version
                               WHERE status = 'P'
                                 AND tmcode = tmb.tmcode)
            AND dn.dn_num = p_dn_num;
   END;

   FUNCTION fbix_mdsrrtab RETURN typ_tb_mdsrrtab
      PIPELINED IS
      v_typ_mdsrrtab typ_mdsrrtab;
   BEGIN

      FOR c_mdsrrtab IN (SELECT request,
                                plcode,
                                status,
                                ts,
                                userid,
                                customer_id,
                                vmd_retry,
                                error_retry,
                                co_id,
                                insert_date,
                                request_update,
                                priority,
                                action_date,
                                switch_id,
                                sccode,
                                worker_pid,
                                action_id,
                                data_1,
                                data_2,
                                data_3,
                                ERROR_CODE,
                                parent_request,
                                provisioning_flag,
                                rating_flag,
                                inserted_by_targys,
                                in_trigger,
                                fu_flag,
                                job_id,
                                orig_request,
                                switch_id_2,
                                porting_event,
                                porting_ufmi,
                                iden_imsi,
                                old_iden_imsi
                           FROM sysadm.mdsrrtab r)

      LOOP
         v_typ_mdsrrtab.request := c_mdsrrtab.request;
         v_typ_mdsrrtab.status  := c_mdsrrtab.status;

         PIPE ROW(v_typ_mdsrrtab);

      END LOOP;

   END;

   PROCEDURE p_bix_tbix_prep_rateplan_bund(p_cursor OUT resultset) IS
   BEGIN
      OPEN p_cursor FOR
         SELECT cd_rate_plan,
                vl_bundle
           FROM tbix_prepaid_rateplan_bundle
          WHERE fl_excluded = 'N';
   END;

   PROCEDURE pbix_contr_nts_bundle(p_cd_contract          IN profile_service.co_id%TYPE,
                                   p_fg_additional_bundle IN tbix_data_service_bundle.fg_additional_bundle%TYPE DEFAULT NULL,
                                   p_cursor               OUT resultset) IS
   BEGIN

      OPEN p_cursor FOR
         SELECT bdl.id_bundle_service,
                bdl.fg_additional_bundle,
                bdl.cd_nts_bundle,
                bdl.nm_nts_bundle
           FROM profile_service              ps,
                pr_serv_status_hist          ssh,
                bix.tbix_data_service_bundle bdl
          WHERE ps.co_id = p_cd_contract
            AND ps.profile_id = ssh.profile_id
            AND ps.co_id = ssh.co_id
            AND ps.sncode = ssh.sncode
            AND ps.status_histno = ssh.histno
            AND ssh.status = 'A'
            AND ssh.sncode = bdl.id_bundle_service
            AND (bdl.fg_additional_bundle = p_fg_additional_bundle OR
                p_fg_additional_bundle IS NULL);

   END;

   PROCEDURE pbix_get_nts_bundle(p_cursor OUT resultset) IS
   BEGIN

      OPEN p_cursor FOR
         SELECT id_bundle_service,
                fg_additional_bundle,
                qa_download_bytes,
                cd_nts_bundle,
                nm_nts_bundle
           FROM bix.tbix_data_service_bundle;
   END;

   PROCEDURE pbix_find_contractid_imsi(p_dn_num   IN VARCHAR2,
                                       p_co_id    OUT NUMBER,
                                       p_port_num OUT VARCHAR2) IS

   BEGIN
      BEGIN

         SELECT cd.co_id,
                pt.port_num
           INTO p_co_id,
                p_port_num
           FROM contr_services_cap csc,
                contr_devices      cd,
                port               pt,
                directory_number   dn
          WHERE dn.dirnum_npcode = 1
            AND csc.dn_id = dn.dn_id
            AND cd.cd_activ_date IS NOT NULL
            AND cd.cd_deactiv_date IS NULL
            AND cd.co_id = csc.co_id
            AND csc.cs_activ_date IS NOT NULL
            AND csc.cs_deactiv_date IS NULL
            AND cd.port_id = pt.port_id
            AND dn.dn_num = p_dn_num;

      EXCEPTION
         WHEN no_data_found THEN
            p_co_id   := NULL;
            p_port_num := NULL;
      END;

   END pbix_find_contractid_imsi;
----------------------------------------------------------------------------------------------------------------------------------
   PROCEDURE pbix_get_free_unit_assignment(    p_cursor                    OUT resultset
                                            )
    ------------------------------------------------------------------------------------------------
    -- CRIADO:     Coelho, Ricardo
    -- DATA:       12/11/2013
    -- OBJETIVO:   SCR 00494 - Roaming Internacional - Fase 2
    --                retorna os dados da tabela bix.tbix_free_unit_assignment
    -- OBSERVAÇÃO:
    ------------------------------------------------------------------------------------------------
    -- ALTERADO:   Rogério Iaqunto
    -- DATA:       18/11/2013
    -- OBJETIVO:   Retirar parametros de retorno e mensagem
    ------------------------------------------------------------------------------------------------
    --
    IS
    -- DECLARAÇÃO DE VARIAVEIS
    --
    --
    BEGIN
        open p_cursor for
        select    cd_service,
                cd_charge_service,
                cd_charge_package,
                cd_free_unit_pack,
                fg_excluded_register,
                dt_creation,
                nm_creation,
                dt_last_modification,
                nm_last_user_modification
        from    bix.tbix_free_unit_assignment;
        --
    EXCEPTION
        WHEN OTHERS THEN
            raise;
    END pbix_get_free_unit_assignment;

   PROCEDURE pbix_get_roaming_international(    p_tmcode                IN        NUMBER            ,
                                                p_spcode                IN        NUMBER            ,
                                                p_sncode                IN        NUMBER            ,
                                                p_fu_pack_id            IN        NUMBER            ,
                                                p_cursor                    OUT resultset        ,
                                                p_retorno                    OUT    VARCHAR2        ,
                                                p_mensagem                    OUT VARCHAR2        )
    ------------------------------------------------------------------------------------------------
    -- CRIADO:     Coelho, Ricardo
    -- DATA:       12/11/2013
    -- OBJETIVO:   SCR 00494 - Roaming Internacional - Fase 2
    --                retorna os dados da tabela sysadm.mpulktmb e sysadm.fup_element_definition
    -- OBSERVAÇÃO:
    ------------------------------------------------------------------------------------------------
    -- ALTERADO:   Nome do desenvolvedor que fez alteracao
    -- DATA:       __/__/____
    -- TS/DEV:     TS____/D____________
    -- OBJETIVO:   Descrever o que foi alterado
    ------------------------------------------------------------------------------------------------
    --
    IS
    -- DECLARAÇÃO DE VARIAVEIS
    --
    --
    BEGIN
        -- INICIALIZAÇÃO DE VARIAVEIS
        g_error_code    := 0; -- esta em -20000
        g_error_message := NULL;
        --
        p_retorno       := 'E0000';
        p_mensagem      := null;
        --
        g_check_point   := 0;
        --
        open p_cursor for
        select    fp.fup_seq                FUP_SEQ,
                fp.version                ELEM_VERSION,
                fp.free_units_volume    FREE_UNITS_AMOUNT,
                tmb.event                EVENT_FEE
        from    sysadm.mpulktmb                    tmb,
                sysadm.fup_element_definition    fp
        where tmb.tmcode = p_tmcode
        and tmb.spcode = p_spcode
        and tmb.sncode = p_sncode
        and fp.fu_pack_id = p_fu_pack_id
        and fp.fup_version = (    select    max (fup_version)
                                from    sysadm.fup_version
                                where fu_pack_id = fp.fu_pack_id    )
        ;
        --
    EXCEPTION
        WHEN OTHERS THEN
            g_error_code    := sqlcode;
            g_error_message    := sqlerrm;
            p_retorno    := 'E2001';
            p_mensagem := 'Erro:' || to_char(g_error_code) || '/' || g_error_message;
    END pbix_get_roaming_international;

   PROCEDURE pbix_upd_fees_period    (    p_co_id                    IN        NUMBER            ,
                                        p_tmcode                IN        NUMBER            ,
                                        p_spcode                IN        NUMBER            ,
                                        p_sncode                IN        NUMBER            ,
                                        p_fu_pack_id            IN        NUMBER            ,
                                        p_fee_class                IN        NUMBER            ,
                                        p_updrowcount                OUT NUMBER            ,
                                        p_retorno                    OUT    VARCHAR2        ,
                                        p_mensagem                    OUT VARCHAR2        )
    ------------------------------------------------------------------------------------------------
    -- CRIADO:     Coelho, Ricardo
    -- DATA:       12/11/2013
    -- OBJETIVO:   SCR 00494 - Roaming Internacional - Fase 2
    --                atualiza o periodo = 0 na tabela sysadm.fees
    -- OBSERVAÇÃO:
    ------------------------------------------------------------------------------------------------
    -- ALTERADO:   Nome do desenvolvedor que fez alteracao
    -- DATA:       __/__/____
    -- TS/DEV:     TS____/D____________
    -- OBJETIVO:   Descrever o que foi alterado
    ------------------------------------------------------------------------------------------------
    --
    IS
    -- DECLARAÇÃO DE VARIAVEIS
    --
    --
    BEGIN
        -- INICIALIZAÇÃO DE VARIAVEIS
        g_error_code    := 0; -- esta em -20000
        g_error_message := NULL;
        --
        p_retorno       := 'E0000';
        p_mensagem      := null;
        --
        g_check_point   := 0;
        --
        update    sysadm.fees
        set        period   = 0
        where    co_id        = p_co_id -- CO_ID onde a free units foi ativa
        and        tmcode        = p_tmcode
        and        spcode        = p_spcode
        and        sncode        = p_sncode
        and        fu_pack_id    = p_fu_pack_id
        and        fee_class    = p_fee_class -- valor fixo
        and        period        > 0
        ;
        p_updrowcount := sql%rowcount;
        --
    EXCEPTION
        WHEN OTHERS THEN
            g_error_code    := sqlcode;
            g_error_message    := sqlerrm;
            p_retorno    := 'E3001';
            p_mensagem := 'Erro:' || to_char(g_error_code) || '/' || g_error_message;
    END pbix_upd_fees_period;

   PROCEDURE pbix_get_inf_contract( p_contract_id   IN  sysadm.contract_all.co_id%TYPE,
                                    p_co_activated  OUT  sysadm.contract_all.co_activated%TYPE,
                                    p_magnus        OUT sysadm.ccontact_all.ccjobdesc%TYPE,
                                    p_custcode      OUT sysadm.customer_all.custcode%TYPE,
                                    p_imei          OUT sysadm.storage_medium.sm_serialnum%TYPE,
                                    p_retorno       OUT VARCHAR2,
                                    p_mensagem      OUT VARCHAR2
                                   ) IS
   ------------------------------------------------------------------------------------------------------
   -- ALTERADO:   Coelho, Ricardo
   -- DATA:       17/01/2014
   -- PROJETO   : SCR 00703 - Siga-me
   -- OBJETIVO:   Criado a procedure para retornar o código magnus do cliente
   ------------------------------------------------------------------------------------------------------
   -- ALTERADO:   Romilda Rosa
   -- DATA:       06/02/2014
   -- PROJETO   : SCR 00703 - Siga-me
   -- OBJETIVO:   Alterado para receber como parametro o contrato em lugar do cliente e
   --             devolver custcode e imei
   -----------------------------------------------------------------------------------------------
   BEGIN

       g_error_code    := 0;
       g_error_message := NULL;
        --
       p_retorno       := 'E0000';
       p_mensagem      := null;

       SELECT co.co_activated, cc.ccjobdesc, c.custcode, sm.sm_serialnum
       INTO p_co_activated, p_magnus, p_custcode, p_imei
       FROM   sysadm.storage_medium sm
            , sysadm.contr_devices cd
            , sysadm.customer_all c
            , sysadm.ccontact_all cc
            , sysadm.contract_all co
       WHERE  co.co_id = p_contract_id
       AND    c.customer_id = co.customer_id
       AND    c.customer_id = cc.customer_id
       AND    cc.ccseq = (SELECT MAX(cc2.ccseq)
                          FROM   ccontact_all cc2
                          WHERE  cc2.customer_id = c.customer_id)
       AND    cd.co_id = co.co_id
       AND    cd.cd_deactiv_date IS NULL
       AND    sm.sm_serialnum = cd.cd_sm_num
       ;
   EXCEPTION
      WHEN NO_DATA_FOUND THEN
            p_magnus := NULL;
            p_custcode := NULL;
            p_imei := NULL;
      WHEN OTHERS THEN
            g_error_code    := sqlcode;
            g_error_message    := sqlerrm;
            p_retorno    := 'E3001';
            p_mensagem := 'Erro:' || to_char(g_error_code) || '/' || g_error_message;
   END pbix_get_inf_contract;

   PROCEDURE pbix_get_migra2gto3g(p_co_id         IN sysadm.info_contr_text.co_id%TYPE,
                                  p_cursor        OUT resultset,
                                  p_retorno          OUT VARCHAR2,
                                  p_mensagem      OUT VARCHAR2
                                  ) IS
   ------------------------------------------------------------------------------------------------------
   -- ALTERADO:   Coelho, Ricardo
   -- DATA:       20/01/2014
   -- PROJETO   : SCR 00703 - Siga-me
   -- OBJETIVO:   Criado a procedure para retornar os dados dos contratos 3G e 2G (IMSI, MSISDN e UFMI)
   --             Parâmetro de entrada: contrato 3G
   -----------------------------------------------------------------------------------------------
   BEGIN
       g_error_code    := 0;
       g_error_message := NULL;
        --
       p_retorno       := 'E0000';
       p_mensagem      := null;

      OPEN p_cursor FOR
       SELECT (SELECT (SELECT port_num
                       FROM port po
                       WHERE po.port_id = cd.port_id)
               FROM contr_devices cd
               WHERE cd.co_id = tb.co_3g
               AND cd_deactiv_date IS NULL)                imsi3g,
              (SELECT (SELECT dn_num
                       FROM directory_number dn
                       WHERE dn.dn_id = cs.dn_id)
               FROM contr_services_cap cs
               WHERE cs.co_id = tb.co_3g
               AND cs.sncode IN (select to_number(vl_bscs_parameter) from bix.tbix_bscs_parameter_detail where cd_bscs_parameter = 'TEL_3G')
               AND seqno = (SELECT MAX(seqno)
                            FROM contr_services_cap c1
                            WHERE c1.co_id = cs.co_id
                            AND c1.sncode = cs.sncode))     msisdn3g,
              (SELECT (SELECT dn_num
                       FROM directory_number dn
                       WHERE dn.dn_id = cs.dn_id)
               FROM contr_services_cap cs
               WHERE cs.co_id = tb.co_3g
               AND cs.sncode IN (select to_number(vl_bscs_parameter) from bix.tbix_bscs_parameter_detail where cd_bscs_parameter = 'RADIO_3G')
               AND cs.cs_activ_date = (SELECT MAX(c1.cs_activ_date)
                                         FROM contr_services_cap c1
                                        WHERE c1.co_id = cs.co_id
                                          AND c1.sncode IN (select to_number(vl_bscs_parameter) from bix.tbix_bscs_parameter_detail where cd_bscs_parameter = 'RADIO_3G')))      ufmi3g,
              (SELECT (SELECT port_num
                       FROM port po
                       WHERE po.port_id = cd.port_id)
               FROM contr_devices cd
               WHERE cd.co_id = tb.co_2g
               AND cd_seqno = (SELECT MAX(cd_seqno)
                               FROM contr_devices c1
                               WHERE c1.co_id = cd.co_id
                               AND ROWNUM = 1 ))           imsi2g,
              (SELECT (SELECT dn_num
                       FROM directory_number dn
                       WHERE dn.dn_id = cs.dn_id)
               FROM contr_services_cap cs
               WHERE cs.co_id = tb.co_2g
               AND cs.sncode IN (select to_number(vl_bscs_parameter) from bix.tbix_bscs_parameter_detail where cd_bscs_parameter = 'TEL_2G')
               AND cs.main_dirnum = 'X'
               AND cs.seqno = (SELECT MAX(seqno)
                                 FROM contr_services_cap c1
                                WHERE c1.co_id = cs.co_id
                                  AND c1.sncode = cs.sncode)
       	       AND cs.sncode in (select sncode from pr_serv_status_hist h
                                  where h.co_id=cs.co_id
                                    and histno = (select Max(histno)
                                                    from pr_serv_status_hist x
                                                   where x.co_id=h.co_id
                                                     and x.profile_id=0
                                                     and x.sncode in(select to_number(vl_bscs_parameter) from bix.tbix_bscs_parameter_detail where cd_bscs_parameter = 'TEL_2G'))))    msisdn2g,
              (SELECT (SELECT dn_num
                       FROM directory_number dn
                       WHERE dn.dn_id = cs.dn_id)
               FROM contr_services_cap cs
               WHERE cs.co_id = tb.co_2g
               AND cs.sncode IN (select to_number(vl_bscs_parameter) from bix.tbix_bscs_parameter_detail where cd_bscs_parameter = 'RADIO_2G')
               AND seqno = (SELECT MAX(seqno)
                            FROM contr_services_cap c1
                            WHERE c1.co_id = cs.co_id
                            AND c1.sncode = cs.sncode))    ufmi2g
       FROM (SELECT co_id              co_3g,
                    TO_NUMBER(text03)  co_2g
             FROM info_contr_text it
             WHERE co_id = p_co_id ) tb
       ;
   EXCEPTION
      WHEN OTHERS THEN
            g_error_code    := sqlcode;
            g_error_message    := sqlerrm;
            p_retorno    := 'E3001';
            p_mensagem := 'Erro:' || to_char(g_error_code) || '/' || g_error_message;
   END pbix_get_migra2gto3g;
   ------------------------------------------------------------------------------------------------------
   -- ALTERADO:   Arai, Leo
   -- DATA:       07/02/2014
   -- PROJETO   : SCR 00703 - Siga-me
   -- OBJETIVO:   Criado a procedure para atualizar a quarentena do nº 2G
   --             Parâmetro de entrada: contrato 3G, data
   --             Atualiza com data+quarentena cadastrato em tabela
   -----------------------------------------------------------------------------------------------

   PROCEDURE pbix_upd_quarentena_sigame(p_co_id       IN NUMBER,
                                        p_data        IN DATE,
                                        p_retorno     OUT VARCHAR2,
                                        p_mensagem    OUT VARCHAR2
                                        ) IS
    v_co_id         number(8);
    v_MSISDN        varchar2(20);
    v_QURTNA        number(3);

   BEGIN
       p_retorno       := 'E0000';
          p_mensagem      := null;

      g_error_code    := 0;
      g_error_message := NULL;

    -- verifica se é dummy customer
    select to_number(cit.text03) into v_co_id
      from sysadm.info_contr_text cit
     where co_id = p_co_id
       and exists (select 'X' from sysadm.contract_all
                    where ch_status='d'
                      and co_id=to_number(cit.text03));
--    v_step := 'Query 1:'||v_co_id;

    select (select dn_num
              from sysadm.directory_number c
             where c.dn_id=a.dn_id
               and c.dirnum_npcode=1
               and c.dn_status='d' ) --tipo telefonia
      into v_MSISDN
      from sysadm.contr_services_cap a
     where a.co_id=v_co_id
       and a.seqno = (select max(seqno)
                        from sysadm.contr_services_cap b
                       where b.co_id=a.co_id
                         and b.sncode in (select to_number(vl_bscs_parameter) from bix.tbix_bscs_parameter_detail where cd_bscs_parameter = 'TEL_2G'))
       and a.sncode in (select sncode from pr_serv_status_hist h
                         where h.co_id=a.co_id
                           and histno = (select Max(histno)
                                           from pr_serv_status_hist x
                                          where x.co_id=h.co_id
                                            and x.profile_id=0
                                            and x.sncode in(select to_number(vl_bscs_parameter) from bix.tbix_bscs_parameter_detail where cd_bscs_parameter = 'TEL_2G')));
--       v_step := 'Query 2:'||v_MSISDN;

     select to_number(vl_bscs_parameter) into v_QURTNA from bix.tbix_bscs_parameter_detail where cd_bscs_parameter='MSISDN2G_QUARENTENA';

     update sysadm.directory_number set dn_status_mod_date=greatest(dn_status_mod_date,nvl(p_data,sysdate)+v_QURTNA) where dn_num= v_MSISDN;
--     p_retorno    := 'E0000';
   EXCEPTION
     WHEN OTHERS THEN
            g_error_code    := sqlcode;
            g_error_message    := sqlerrm;
            p_retorno    := 'E3001';
            p_mensagem := 'Erro:' || to_char(g_error_code) || '/' || g_error_message;

   END;

   ------------------------------------------------------------------------------------------------------
   -- ALTERADO:   Arai, Leo
   -- DATA:       31/03/2014
   -- PROJETO   : SCR 00703 - Siga-me
   -- OBJETIVO:   Criado a procedure para retornar nº2G
   --             Parâmetro de entrada: contrato 3G
   -----------------------------------------------------------------------------------------------

   PROCEDURE pbix_get_msisdn2g(p_co_id       IN NUMBER,
                               p_msisdn      OUT VARCHAR2,
                               p_retorno     OUT VARCHAR2,
                               p_mensagem    OUT VARCHAR2
                                        ) IS
    v_co_id         number(8);
    v_MSISDN        varchar2(20);
   BEGIN
      p_retorno       := 'E0000';
      p_mensagem      := null;
      g_error_code    := 0;
      g_error_message := NULL;

    -- verifica se é dummy customer
    select to_number(cit.text03) into v_co_id
      from sysadm.info_contr_text cit
     where co_id = p_co_id
       and exists (select 'X' from sysadm.contract_all
                    where ch_status='d'
                      and co_id=to_number(cit.text03));

    select (select dn_num
              from sysadm.directory_number c
             where c.dn_id=a.dn_id
               and c.dirnum_npcode=1
               and c.dn_status='d')
      into v_MSISDN
      from sysadm.contr_services_cap a
     where a.co_id=v_co_id
       and a.seqno = (select max(seqno)
                        from sysadm.contr_services_cap b
                       where b.co_id=a.co_id
                         and b.sncode=a.sncode)
       and a.sncode in (select sncode from pr_serv_status_hist h
                         where h.co_id=a.co_id
                           and histno = (select Max(histno)
                                           from pr_serv_status_hist x
                                          where x.co_id=h.co_id
                                            and x.profile_id=0
                                            and x.sncode in(select to_number(vl_bscs_parameter) from bix.tbix_bscs_parameter_detail where cd_bscs_parameter = 'TEL_2G')));
       p_msisdn := v_MSISDN;

   EXCEPTION
     WHEN OTHERS THEN
            g_error_code    := sqlcode;
            g_error_message    := sqlerrm;
            p_retorno    := 'E3001';
            p_mensagem := 'Erro:' || to_char(g_error_code) || '/' || g_error_message;

   END;

PROCEDURE pbix_get_data_pooling_info(p_customer_id IN sysadm.customer_all.customer_id%TYPE,
                                        p_cursor OUT resultset) IS

      ------------------------------------------------------------------------------------------------------
      -- CRIACAO   : Bruno Cavalcanti
      -- DATA      : 01/04/2014
      -- PROJETO   : 3Data Pooling
      -- OBJETIVO  : Retornar estrutura de pooling de dados do cleinte passado como parametro
      -------------------------------------------------------------------------------------------------------
      -- ALTERADO  :
      -- DATA      :
      -- PROJETO   :
      -- OBJETIVO  :
      -------------------------------------------------------------------------------------------------------

   BEGIN
      OPEN p_cursor FOR
         SELECT  /*+ RULE */
          c.customer_id "CUSTOMER_ID",
          ca.co_id "CO_ID",
          p.port_num "IMSI",
          ph.sncode "SNCODE",
          PH.STATUS "SERVICE_STATUS",
          PH.VALID_FROM_DATE "VALID_FROM",
          ca.ch_status "CONTRACT_STATUS",
          (SELECT   m.request
             FROM   mdsrrtab m
            WHERE   m.request = ph.request_id) "PENDING_REQUEST",
          (select
            PV2.PRM_VALUE_STRING
          from
            parameter_value pv2
          where
              pv2.sncode = ph.sncode
          AND pv2.co_id = ph.co_id
          AND PV2.PROFILE_ID = 0
          AND pv2.parameter_id IN (62)
          AND pv2.PRM_SEQNO = (select max(pv3.PRM_SEQNO)
                                from
                              parameter_value pv3
                               where
                                 pv3.prm_value_id = pv2.prm_value_id
                              )) "MASTER_IMSI"
     FROM   port p,
          contr_devices cd,
          (  SELECT   customer_id
                 FROM   customer_all
           CONNECT BY   PRIOR customer_id = customer_id_high
           START WITH   customer_id = p_customer_id) c,
          contract_all ca,
          pr_serv_status_hist ph
    WHERE       c.customer_id = ca.customer_id
          AND p.port_id = cd.port_id
          AND cd.cd_seqno = (SELECT   MAX (cd_seqno)
                               FROM   contr_devices cd2
                              WHERE   cd2.co_id = cd.co_id)
          AND ca.co_id = cd.co_id
          AND ph.profile_id = 0
          AND ph.co_id = ca.co_id
          AND ph.sncode IN (2501,2502,2503)
          AND ph.histno =
                (SELECT   MAX (histno)
                   FROM   pr_serv_status_hist ph2
                  WHERE   ph2.sncode = ph.sncode AND ph2.co_id = ph.co_id)
    ORDER BY   ca.co_id, ph.sncode, ph.VALID_FROM_DATE;
   END;


   PROCEDURE pbix_get_market_services(p_vmd_markets IN t_tab_vmd_market,
                                      p_cursor       OUT resultset) IS
   BEGIN
      OPEN p_cursor FOR
	  SELECT
          vsc.subsystem_market market,
          vsc.register_command command
      FROM
          vmd.vmd_service_commands vsc
      WHERE
          vsc.subsystem_market in (SELECT vm.column_value FROM TABLE(p_vmd_markets) vm) ;
   END;


PROCEDURE pbix_get_contract_reason(p_co_id  IN NUMBER,
                                   p_cursor OUT resultset) IS
      ------------------------------------------------------------------------------------------------------
      -- DATA      : 24/07/2014
      -- PROJETO   : Data Pooling 1.5
      -- OBJETIVO  : Retornar dois ultimos motivos na contract_history do contrado passado como parametro
      -------------------------------------------------------------------------------------------------------

    BEGIN
      OPEN p_cursor FOR
         SELECT o.ch_reason    AS ch_reason_old,
            n.ch_reason    ch_reason,
            n.ch_validfrom
		FROM contract_history n,
            contract_history o
		WHERE n.co_id = p_co_id
			AND n.co_id = o.co_id
			AND o.ch_seqno = n.ch_seqno -1
			AND n.ch_validfrom = (SELECT MAX(chi.ch_validfrom) FROM contract_history chi WHERE chi.co_id = n.co_id);

   END pbix_get_contract_reason;

END KBIX_EPS;



1 linha selecionada.

18:18:54 PNXTL08.IT_PNET3>spool off;
