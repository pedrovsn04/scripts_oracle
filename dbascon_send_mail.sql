14:50:32 E3NXTL01.DBASCON>set lines 20000
14:50:35 E3NXTL01.DBASCON>set pages 20000
14:50:37 E3NXTL01.DBASCON>select dbms_metadata.get_ddl('PROCEDURE','SEND_MAIL','DBASCON') from dual;

DBMS_METADATA.GET_DDL('PROCEDURE','SEND_MAIL','DBASCON')
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

  CREATE OR REPLACE PROCEDURE "DBASCON"."SEND_MAIL" (
 sender IN VARCHAR2 ,
 recipient IN VARCHAR2,
 subject IN VARCHAR2,
 message IN VARCHAR2,
 sendername IN VARCHAR2 default null,
 recipientname IN VARCHAR2 default null,
 ccname IN VARCHAR2 := NULL,
 ccemail IN VARCHAR2 := NULL,
 bccname IN VARCHAR2 := NULL,
 bccemail IN VARCHAR2 := NULL,
 mailhost IN VARCHAR2 := 'smtp.nextel.com.br',
 Port IN NUMBER := 25)
IS
 c_char_sep CONSTANT VARCHAR2(1) := ',';
 mail_conn  utl_smtp.connection;
 vrData     RAW(32767);

    PROCEDURE mult_rec(p_rec IN VARCHAR) IS
      v_rec VARCHAR2(2000) := p_rec;
    BEGIN
      IF v_rec IS NULL THEN
        RETURN;
      END IF;

      -- Varre a string, para mandar para multiplos recipientes
      LOOP
        EXIT WHEN instr(v_rec, c_char_sep) = 0;
        UTL_smtp.rcpt(mail_conn, substr(v_rec, 1, instr(v_rec, c_char_sep)-1));
        v_rec := trim(substr(v_rec, instr(v_rec, c_char_sep)+1));
      END LOOP;
      UTL_smtp.rcpt(mail_conn, v_rec);
    END;
BEGIN
    mail_conn := UTL_smtp.open_connection(mailhost,Port);
    UTL_smtp.helo(mail_conn, mailhost);
    UTL_smtp.mail(mail_conn, sender);

    mult_rec(recipient);
    mult_rec(ccemail);
    mult_rec(bccemail);

    UTL_smtp.open_data(mail_conn);

    IF ( sendername IS NULL ) THEN
        UTL_smtp.WRITE_RAW_DATA(mail_conn,UTL_RAW.CAST_TO_RAW('From: ' || '"' || sender || '" <' || sender ||'>' || UTL_tcp.CRLF));
    ELSE
        UTL_smtp.WRITE_RAW_DATA(mail_conn,UTL_RAW.CAST_TO_RAW('From: ' || '"' || sendername || '" <' || sender ||'>' || UTL_tcp.CRLF));
    END IF;

    IF ( recipientname IS NULL ) THEN
        UTL_smtp.WRITE_RAW_DATA(mail_conn,UTL_RAW.CAST_TO_RAW('To: ' || '"' || recipient || '" <' || recipient ||'>' || UTL_tcp.CRLF));
    ELSE
        UTL_smtp.WRITE_RAW_DATA(mail_conn,UTL_RAW.CAST_TO_RAW('To: ' || '"' || recipientname || '" <' || recipient ||'>' || UTL_tcp.CRLF));
    END IF;

    IF (ccemail IS NOT NULL) THEN
        UTL_smtp.write_data(mail_conn, 'Cc: ' || '"' || ccname || '" <' || ccemail ||'>' || UTL_tcp.CRLF);
    END IF;

    IF (bccemail IS NOT NULL) THEN
        UTL_smtp.write_data(mail_conn, 'Bcc: ' || '"' || bccname || '" <' || bccemail ||'>' || UTL_tcp.CRLF);
    END IF;

    UTL_SMTP.WRITE_RAW_DATA( MAIL_CONN,UTL_RAW.CAST_TO_RAW('Subject:' ||SUBJECT||UTL_TCP.CRLF));

    UTL_smtp.write_data(mail_conn, UTL_tcp.CRLF);

    vrData := utl_raw.cast_to_raw(message);
    UTL_smtp.write_raw_data(mail_conn, vrData);

    UTL_smtp.close_data(mail_conn);
    UTL_smtp.quit(mail_conn);

    EXCEPTION
    WHEN UTL_smtp.transient_error OR UTL_smtp.permanent_error THEN
        UTL_smtp.quit(mail_conn);
        dbms_output.put_line(sqlerrm);
    WHEN OTHERS THEN
        UTL_smtp.quit(mail_conn);
        dbms_output.put_line(sqlerrm);
    END send_mail;


1 linha selecionada.

Decorrido: 00:00:01.51
14:51:01 E3NXTL01.DBASCON>spool off;
